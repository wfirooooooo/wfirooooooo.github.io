<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>wfir&#39;s tech blog</title>
  <meta name="author" content="wfir">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="wfir&#39;s tech blog"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="wfir&#39;s tech blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">wfir&#39;s tech blog</a></h1>
  <h2><a href="/"></a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper">
  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2016-11-11T02:49:39.000Z"><a href="/2016/11/11/Solr简单部署配置/">2016-11-11</a></time>
      
      
  
    <h1 class="title"><a href="/2016/11/11/Solr简单部署配置/">Solr简单部署配置</a></h1>
  

    </header>
    <div class="entry">
      
        <p><strong> Solr版本为6.2.1 </strong></p>
<h2 id="u4E0B_u8F7D_u8F6F_u4EF6_u5305"><a href="#u4E0B_u8F7D_u8F6F_u4EF6_u5305" class="headerlink" title="下载软件包"></a>下载软件包</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src</span><br><span class="line">wget xxx/solr-<span class="number">6.2</span>.<span class="number">1</span>.tgz</span><br></pre></td></tr></table></figure>
<h2 id="u89E3_u538B"><a href="#u89E3_u538B" class="headerlink" title="解压"></a>解压</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gunzip solr-<span class="number">6.2</span>.<span class="number">1</span>.tgz</span><br><span class="line">tar xf solr-<span class="number">6.2</span>.<span class="number">1</span>.tar</span><br><span class="line">mv solr-<span class="number">6.2</span>.<span class="number">1</span> solr</span><br></pre></td></tr></table></figure>
<h2 id="u90E8_u7F72"><a href="#u90E8_u7F72" class="headerlink" title="部署"></a>部署</h2><ol>
<li><p>把solr/server/solr-webapp/webapp文件夹拷贝到tomcat的webapps文件夹下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp <span class="operator">-a</span> solr/server/solr-webapp/webapp tomcat/webapps/solr</span><br></pre></td></tr></table></figure>
</li>
<li><p>拷贝jar包到tomcat的solr项目中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp <span class="operator">-a</span> solr/server/lib/ext/*  tomcat/webapps/solr/WEB-INF/lib/</span><br><span class="line">cp <span class="operator">-a</span> solr/dist/solr-dataimporthandler-* tomcat/webapps/solr/WEB-INF/lib/</span><br></pre></td></tr></table></figure>
</li>
<li><p>拷贝solrhome文件夹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp <span class="operator">-a</span> solr/server/solr /usr/<span class="built_in">local</span>/solrhome</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="u914D_u7F6E"><a href="#u914D_u7F6E" class="headerlink" title="配置"></a>配置</h2><ol>
<li><p>配置solrhome<br>编辑tomcat/webapps/solr/WEB-INF/web.xml文件,取消以下内容注释并添加solrhome</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#60;env-entry&#62;&#10;   &#60;env-entry-name&#62;solr/home&#60;/env-entry-name&#62;&#10;   &#60;env-entry-value&#62;/usr/local/solrhome&#60;/env-entry-value&#62;&#10;   &#60;env-entry-type&#62;java.lang.String&#60;/env-entry-type&#62;&#10;&#60;/env-entry&#62;</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置solr的log4j文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp <span class="operator">-a</span> solr/server/resources/<span class="built_in">log</span>4j.properties  tomcat/webapps/solr/WEB-INF/classes/</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动tomcat,访问solr web</p>
</li>
<li><p>添加第一个core</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/solrhome</span><br><span class="line">mkdir newcore</span><br><span class="line">cp <span class="operator">-a</span> solr/server/solr/configsets/sample_techproducts_configs/conf /usr/<span class="built_in">local</span>/solrhome/newcore/</span><br></pre></td></tr></table></figure>
</li>
<li><p>在solr的admin界面,add core,在name和instancedir下输入新建core的名字newcore,即可看到新建的core.</p>
</li>
</ol>
<h2 id="u53C2_u8003_u7AD9_u70B9"><a href="#u53C2_u8003_u7AD9_u70B9" class="headerlink" title="参考站点"></a>参考站点</h2><p><a href="http://blog.csdn.net/uchenxy/article/details/52882709" target="_blank" rel="external">http://blog.csdn.net/uchenxy/article/details/52882709</a></p>
<p>have fun !</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2016-09-09T02:18:04.000Z"><a href="/2016/09/09/使用hubot构建slack机器人/">2016-09-09</a></time>
      
      
  
    <h1 class="title"><a href="/2016/09/09/使用hubot构建slack机器人/">使用hubot构建slack机器人</a></h1>
  

    </header>
    <div class="entry">
      
        <p>鼓捣了鼓捣用hubot构建slack机器人,简单记录一下.</p>
<h1 id="u73AF_u5883_u4FE1_u606F"><a href="#u73AF_u5883_u4FE1_u606F" class="headerlink" title="环境信息"></a>环境信息</h1><ul>
<li>美团云主机</li>
<li>CentOS 7.0</li>
</ul>
<h1 id="u5B89_u88C5nodejs_u548Cnpm"><a href="#u5B89_u88C5nodejs_u548Cnpm" class="headerlink" title="安装nodejs和npm"></a>安装nodejs和npm</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install -y npm</span><br><span class="line">node -v</span><br></pre></td></tr></table></figure>
<h1 id="u5347_u7EA7npm"><a href="#u5347_u7EA7npm" class="headerlink" title="升级npm"></a>升级npm</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install npm -g </span><br><span class="line">npm -v</span><br></pre></td></tr></table></figure>
<h1 id="u5B89_u88C5hubot_generator"><a href="#u5B89_u88C5hubot_generator" class="headerlink" title="安装hubot generator"></a>安装hubot generator</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g hubot coffee-script yo generator-hubot</span><br></pre></td></tr></table></figure>
<h1 id="u65B0_u5EFA_u6587_u4EF6_u5939_u5E76_u914D_u7F6E_u6743_u9650"><a href="#u65B0_u5EFA_u6587_u4EF6_u5939_u5E76_u914D_u7F6E_u6743_u9650" class="headerlink" title="新建文件夹并配置权限"></a>新建文件夹并配置权限</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir /root/hubot</span><br><span class="line">mkdir /root/.config</span><br><span class="line">chmod -R g+rwx /root/.config</span><br><span class="line">chmod -R g+rwx /root/hubot</span><br><span class="line">chmod -R g+rwx /root/.npm</span><br></pre></td></tr></table></figure>
<h1 id="u5B89_u88C5hubot"><a href="#u5B89_u88C5hubot" class="headerlink" title="安装hubot"></a>安装hubot</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /root/hubot</span><br><span class="line">yo hubot(根据提示操作,Bot adapter选择slack</span><br></pre></td></tr></table></figure>
<h1 id="slack_u76F8_u5173_u914D_u7F6E"><a href="#slack_u76F8_u5173_u914D_u7F6E" class="headerlink" title="slack相关配置"></a>slack相关配置</h1><ol>
<li><p><a href="https://www.liudon.org/1329.html" target="_blank" rel="external">在slack上申请bot账号</a></p>
</li>
<li><p>配置slack,根据申请的token运行hubot</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">env HUBOT_SLACK_TOKEN=xxx ./bin/hubot --adapter slack</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="u8BA9hubot_u80FD_u591F_u6267_u884C_u811A_u672C"><a href="#u8BA9hubot_u80FD_u591F_u6267_u884C_u811A_u672C" class="headerlink" title="让hubot能够执行脚本"></a>让hubot能够执行脚本</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hubot-script-shellcmd</span><br></pre></td></tr></table></figure>
<p> <strong>tips</strong>:</p>
<ol>
<li><p>编写的脚本需要放到以下文件夹中</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/root/hubot/node_modules/hubot-script-shellcmd/bash/handlers</span><br></pre></td></tr></table></figure>
</li>
<li><p>脚本文件需要有执行权限</p>
</li>
</ol>
<h1 id="u53C2_u8003_u7AD9_u70B9"><a href="#u53C2_u8003_u7AD9_u70B9" class="headerlink" title="参考站点"></a>参考站点</h1><p><a href="https://hubot.github.com/docs/" target="_blank" rel="external">https://hubot.github.com/docs/</a></p>
<p><a href="https://github.com/slackhq/hubot-slack" target="_blank" rel="external">https://github.com/slackhq/hubot-slack</a></p>
<p><a href="https://segmentfault.com/a/1190000006681056" target="_blank" rel="external">https://segmentfault.com/a/1190000006681056</a></p>
<p><a href="https://www.liudon.org/1329.html" target="_blank" rel="external">https://www.liudon.org/1329.html</a></p>
<p>have fun !</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2016-08-26T01:56:01.000Z"><a href="/2016/08/26/在阿里云ECS上部署OpenVPN/">2016-08-26</a></time>
      
      
  
    <h1 class="title"><a href="/2016/08/26/在阿里云ECS上部署OpenVPN/">在阿里云ECS上部署OpenVPN</a></h1>
  

    </header>
    <div class="entry">
      
        <p>在阿里云上有一批ECS虚拟机,大部分都走的VPC私有网络,一个路由器下面分配了多个交换机,有私有网段.需要安装一个VPN,方便登陆管理.</p>
<p>此次的平台是CentOS 7,和CentOS 6不同的地方有两个,一个是使用Systemd来管理OpenVPN的服务,另一个是使用FirewallD进行防火墙管理.<br>部署过程如下.</p>
<h1 id="u5B89_u88C5"><a href="#u5B89_u88C5" class="headerlink" title="安装"></a>安装</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y openvpn easy-rsa</span><br></pre></td></tr></table></figure>
<h1 id="u670D_u52A1_u7AEF_u914D_u7F6E"><a href="#u670D_u52A1_u7AEF_u914D_u7F6E" class="headerlink" title="服务端配置"></a>服务端配置</h1><h2 id="u914D_u7F6E_u6587_u4EF6"><a href="#u914D_u7F6E_u6587_u4EF6" class="headerlink" title="配置文件"></a>配置文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp <span class="operator">-a</span> /usr/share/easy-rsa /etc/openvpn/</span><br></pre></td></tr></table></figure>
<h2 id="u7F16_u8F91vars"><a href="#u7F16_u8F91vars" class="headerlink" title="编辑vars"></a>编辑vars</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/openvpn/easy-rsa/<span class="number">2.0</span></span><br><span class="line">vi vars 编辑以下内容</span><br><span class="line"><span class="built_in">export</span> KEY_COUNTRY=<span class="string">"CN"</span></span><br><span class="line"><span class="built_in">export</span> KEY_PROVINCE=<span class="string">"BJ"</span></span><br><span class="line"><span class="built_in">export</span> KEY_CITY=<span class="string">"Beijing"</span></span><br><span class="line"><span class="built_in">export</span> KEY_ORG=<span class="string">"TT"</span></span><br><span class="line"><span class="built_in">export</span> KEY_EMAIL=<span class="string">"admin@example.com"</span></span><br><span class="line"><span class="built_in">export</span> KEY_OU=<span class="string">"IT"</span></span><br></pre></td></tr></table></figure>
<h2 id="u751F_u6210_u8BC1_u4E66"><a href="#u751F_u6210_u8BC1_u4E66" class="headerlink" title="生成证书"></a>生成证书</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/openvpn/easy-rsa/<span class="number">2.0</span></span><br><span class="line">ln <span class="operator">-s</span> openssl-<span class="number">1.0</span>.<span class="number">0</span>.cnf openssl.cnf</span><br><span class="line"><span class="built_in">source</span> ./vars</span><br><span class="line"><span class="built_in">source</span> ./clean-all</span><br><span class="line">./build-ca</span><br><span class="line">./build-key-server aliyunvpn</span><br><span class="line">./bulid-key aliyunuser</span><br><span class="line">./build-dh</span><br></pre></td></tr></table></figure>
<h2 id="u914D_u7F6E_u6587_u4EF6-1"><a href="#u914D_u7F6E_u6587_u4EF6-1" class="headerlink" title="配置文件"></a>配置文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cp <span class="operator">-a</span> /etc/openvpn/easy-rsa/<span class="number">2.0</span>/keys/ca.crt /etc/openvpn/</span><br><span class="line">cp <span class="operator">-a</span> /etc/openvpn/easy-rsa/<span class="number">2.0</span>/keys/aliyunvpn.crt /etc/openvpn/</span><br><span class="line">cp <span class="operator">-a</span> /etc/openvpn/easy-rsa/<span class="number">2.0</span>/keys/aliyunvon.key /etc/openvpn/</span><br><span class="line">cp <span class="operator">-a</span> /etc/openvpn/easy-rsa/<span class="number">2.0</span>/keys/dh2048.pem /etc/openvpn/</span><br><span class="line">cp /usr/share/doc/openvpn-<span class="number">2.3</span>.<span class="number">11</span>/sample/sample-config-files/server.conf /etc/openvpn/</span><br></pre></td></tr></table></figure>
<h2 id="server-conf_u5185_u5BB9_u5982_u4E0B"><a href="#server-conf_u5185_u5BB9_u5982_u4E0B" class="headerlink" title="server.conf内容如下"></a>server.conf内容如下</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">port 1194&#10;proto udp&#10;dev tun&#10;ca ca.crt&#10;cert aliyunvpn.crt&#10;key aliyunvpn.key  # This file should be kept secret&#10;;plugin /etc/openvpn/openvpn-plugin-auth-pam.so openvpn&#10;;client-cert-not-required&#10;;username-as-common-name&#10;dh dh2048.pem&#10;server 172.16.0.0 255.255.255.0&#10;ifconfig-pool-persist ipp.txt&#10;push &#34;route 172.16.0.0 255.240.0.0&#34;&#10;push &#34;dhcp-option DNS 223.5.5.5&#34;&#10;client-to-client&#10;keepalive 10 120&#10;comp-lzo&#10;user nobody&#10;group nobody&#10;persist-key&#10;persist-tun&#10;status /var/log/openvpn-status.log&#10;log    /var/log/openvpn.log&#10;verb 3</span><br></pre></td></tr></table></figure>
<h2 id="u5F00_u542F_u8F6C_u53D1"><a href="#u5F00_u542F_u8F6C_u53D1" class="headerlink" title="开启转发"></a>开启转发</h2><p>vi /etc/sysctl.conf 添加<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.ip_forward=1</span><br></pre></td></tr></table></figure></p>
<p>生效<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -p</span><br></pre></td></tr></table></figure></p>
<h2 id="firewall_u9632_u706B_u5899_u6DFB_u52A0_u7B56_u7565"><a href="#firewall_u9632_u706B_u5899_u6DFB_u52A0_u7B56_u7565" class="headerlink" title="firewall防火墙添加策略"></a>firewall防火墙添加策略</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --permanent --add-service openvpn</span><br><span class="line">firewall-cmd --permanent --add-masquerade</span><br></pre></td></tr></table></figure>
<h2 id="systemctl_u6DFB_u52A0_u7CFB_u7EDF_u670D_u52A1_u5E76_u542F_u52A8"><a href="#systemctl_u6DFB_u52A0_u7CFB_u7EDF_u670D_u52A1_u5E76_u542F_u52A8" class="headerlink" title="systemctl添加系统服务并启动"></a>systemctl添加系统服务并启动</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> openvpn@server.service</span><br><span class="line">systemctl start openvpn@server.service</span><br></pre></td></tr></table></figure>
<h2 id="u963F_u91CC_u4E91_u5B89_u5168_u7EC4_u914D_u7F6E"><a href="#u963F_u91CC_u4E91_u5B89_u5168_u7EC4_u914D_u7F6E" class="headerlink" title="阿里云安全组配置"></a>阿里云安全组配置</h2><p>添加一条允许UDP 1194端口访问的规则</p>
<h1 id="u5BA2_u6237_u7AEF_u914D_u7F6E_28linux_u4E3A_u4F8B_29"><a href="#u5BA2_u6237_u7AEF_u914D_u7F6E_28linux_u4E3A_u4F8B_29" class="headerlink" title="客户端配置(linux为例)"></a>客户端配置(linux为例)</h1><h2 id="u5B89_u88C5openvpn"><a href="#u5B89_u88C5openvpn" class="headerlink" title="安装openvpn"></a>安装openvpn</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y openvpn</span><br></pre></td></tr></table></figure>
<h2 id="u590D_u5236_u670D_u52A1_u7AEF_u4EE5_u4E0B_u6587_u4EF6_u5230_u5BA2_u6237_u7AEF_u5BF9_u5E94_u6587_u4EF6_u5939_u4E2D"><a href="#u590D_u5236_u670D_u52A1_u7AEF_u4EE5_u4E0B_u6587_u4EF6_u5230_u5BA2_u6237_u7AEF_u5BF9_u5E94_u6587_u4EF6_u5939_u4E2D" class="headerlink" title="复制服务端以下文件到客户端对应文件夹中"></a>复制服务端以下文件到客户端对应文件夹中</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aliyunuser.crt&#10;aliyunuser.key&#10;ca.crt</span><br></pre></td></tr></table></figure>
<h2 id="aliyun-ovpn_u914D_u7F6E"><a href="#aliyun-ovpn_u914D_u7F6E" class="headerlink" title="aliyun.ovpn配置"></a>aliyun.ovpn配置</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client&#10;dev tun&#10;proto udp&#10;remote remote ip or domain&#10;port 1194&#10;remote-random&#10;resolv-retry infinite&#10;nobind&#10;persist-key&#10;persist-tun&#10;ca /etc/openvpn/config/ca.crt&#10;cert /etc/openvpn/config/aliyunuser.crt&#10;key /etc/openvpn/config/aliyunuser.key&#10;ns-cert-type server&#10;route-delay 2&#10;comp-lzo&#10;verb 3</span><br></pre></td></tr></table></figure>
<h2 id="u542F_u52A8_u547D_u4EE4"><a href="#u542F_u52A8_u547D_u4EE4" class="headerlink" title="启动命令"></a>启动命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openvpn --config /etc/openvpn/config/aliyun.ovpn</span><br></pre></td></tr></table></figure>
<h1 id="u9644_u5F55_PAM_u548C_u5BC6_u7801_u8BA4_u8BC1_u65B9_u5F0F"><a href="#u9644_u5F55_PAM_u548C_u5BC6_u7801_u8BA4_u8BC1_u65B9_u5F0F" class="headerlink" title="附录 PAM和密码认证方式"></a>附录 PAM和密码认证方式</h1><h2 id="u590D_u5236openvpn-plugin-auth-pam-so_u5230openvpn_u76EE_u5F55_u4E0B"><a href="#u590D_u5236openvpn-plugin-auth-pam-so_u5230openvpn_u76EE_u5F55_u4E0B" class="headerlink" title="复制openvpn-plugin-auth-pam.so到openvpn目录下"></a>复制openvpn-plugin-auth-pam.so到openvpn目录下</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp <span class="operator">-a</span> /usr/lib64/openvpn/plugins/openvpn-plugin-auth-pam.so /etc/openvpn/</span><br></pre></td></tr></table></figure>
<h2 id="u5728/etc/pam-d/_u76EE_u5F55_u4E0B_u521B_u5EFAopenvpn_u6587_u4EF6"><a href="#u5728/etc/pam-d/_u76EE_u5F55_u4E0B_u521B_u5EFAopenvpn_u6587_u4EF6" class="headerlink" title="在/etc/pam.d/目录下创建openvpn文件"></a>在/etc/pam.d/目录下创建openvpn文件</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/pam.d/openvpn&#10;auth    required        pam_unix.so    shadow    nodelay&#10;account required        pam_unix.so</span><br></pre></td></tr></table></figure>
<h2 id="u4FEE_u6539/etc/openvpn/server-conf_2C_u6DFB_u52A0_u4EE5_u4E0B_u5185_u5BB9"><a href="#u4FEE_u6539/etc/openvpn/server-conf_2C_u6DFB_u52A0_u4EE5_u4E0B_u5185_u5BB9" class="headerlink" title="修改/etc/openvpn/server.conf,添加以下内容"></a>修改/etc/openvpn/server.conf,添加以下内容</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">plugin /etc/openvpn/openvpn-plugin-auth-pam.so openvpn&#10;client-cert-not-required&#10;username-as-common-name</span><br></pre></td></tr></table></figure>
<h2 id="u521B_u5EFA_u8D26_u6237"><a href="#u521B_u5EFA_u8D26_u6237" class="headerlink" title="创建账户"></a>创建账户</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">useradd aliyunuser <span class="operator">-s</span> /sbin/nologin</span><br><span class="line">passwd aliyunuser</span><br></pre></td></tr></table></figure>
<h2 id="u5BA2_u6237_u7AEF_u914D_u7F6E"><a href="#u5BA2_u6237_u7AEF_u914D_u7F6E" class="headerlink" title="客户端配置"></a>客户端配置</h2><p>aliyun.ovpn<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client&#10;dev tun&#10;proto udp&#10;remote remote server ip&#10;port 1194&#10;remote-random&#10;resolv-retry infinite&#10;nobind&#10;persist-key&#10;persist-tun&#10;ca /etc/openvpn/config/ca.crt&#10;auth-user-pass&#10;ns-cert-type server&#10;route-delay 2&#10;comp-lzo&#10;verb 3</span><br></pre></td></tr></table></figure></p>
<p>user文件<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username&#10;password</span><br></pre></td></tr></table></figure></p>
<p>客户端启动<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/sbin/openvpn --config /etc/openvpn/config/aliyun.ovpn --auth-user-pass /etc/openvpn/config/user</span><br></pre></td></tr></table></figure></p>
<h1 id="u53C2_u8003_u7AD9_u70B9"><a href="#u53C2_u8003_u7AD9_u70B9" class="headerlink" title="参考站点"></a>参考站点</h1><p><a href="https://help.aliyun.com/knowledge_detail/42521.html" target="_blank" rel="external">https://help.aliyun.com/knowledge_detail/42521.html</a></p>
<p><a href="https://wanglu.info/983.html" target="_blank" rel="external">https://wanglu.info/983.html</a></p>
<p><a href="https://www.digitalocean.com/community/tutorials/how-to-setup-and-configure-an-openvpn-server-on-centos-7" target="_blank" rel="external">https://www.digitalocean.com/community/tutorials/how-to-setup-and-configure-an-openvpn-server-on-centos-7</a></p>
<p><a href="http://unix.stackexchange.com/questions/149144/configuring-openvpn-to-use-firewalld-instead-of-iptables-on-centos-7" target="_blank" rel="external">http://unix.stackexchange.com/questions/149144/configuring-openvpn-to-use-firewalld-instead-of-iptables-on-centos-7</a></p>
<p><a href="http://unix.stackexchange.com/questions/88667/openvpn-socket-bind-failed-on-local-address-af-inet-ip1194-cannot-assign-r" target="_blank" rel="external">http://unix.stackexchange.com/questions/88667/openvpn-socket-bind-failed-on-local-address-af-inet-ip1194-cannot-assign-r</a></p>
<p><a href="https://www.linuxsysadmintutorials.com/setup-pam-authentication-with-openvpns-auth-pam-module.html" target="_blank" rel="external">https://www.linuxsysadmintutorials.com/setup-pam-authentication-with-openvpns-auth-pam-module.html</a></p>
<p><a href="https://wiki.archlinux.org/index.php/OpenVPN_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87" target="_blank" rel="external">https://wiki.archlinux.org/index.php/OpenVPN_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87</a>)</p>
<p><a href="https://yq.aliyun.com/articles/14793" target="_blank" rel="external">https://yq.aliyun.com/articles/14793</a></p>
<p><a href="http://www.gooth.org/archives/1009" target="_blank" rel="external">http://www.gooth.org/archives/1009</a></p>
<p>have fun !</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2016-07-06T07:32:44.000Z"><a href="/2016/07/06/redigo简单使用/">2016-07-06</a></time>
      
      
  
    <h1 class="title"><a href="/2016/07/06/redigo简单使用/">redigo简单使用</a></h1>
  

    </header>
    <div class="entry">
      
        <p>今天简单使用了一下Golang的Redis Client程序包Redigo.记录一下比较关注的几个方面.</p>
<h1 id="u5B89_u88C5Redigo"><a href="#u5B89_u88C5Redigo" class="headerlink" title="安装Redigo"></a>安装Redigo</h1><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> get github.com/garyburd/redigo/redis</span><br></pre></td></tr></table></figure>
<p>会在GOPATH目录下的src和pkg文件夹中生成对应的包文件</p>
<h1 id="u8FDE_u63A5Redis_u670D_u52A1"><a href="#u8FDE_u63A5Redis_u670D_u52A1" class="headerlink" title="连接Redis服务"></a>连接Redis服务</h1><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">c, err := redis.Dial(<span class="string">"tcp"</span>, <span class="string">"192.168.10.12:6379"</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="constant">nil</span> &#123;</span><br><span class="line">	<span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> c.Close()</span><br></pre></td></tr></table></figure>
<h1 id="u8F93_u5165Redis_u5BC6_u7801"><a href="#u8F93_u5165Redis_u5BC6_u7801" class="headerlink" title="输入Redis密码"></a>输入Redis密码</h1><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c.Send(<span class="string">"auth"</span>, <span class="string">"xxx"</span>)</span><br></pre></td></tr></table></figure>
<h1 id="u9009_u62E9Redis_u5E93"><a href="#u9009_u62E9Redis_u5E93" class="headerlink" title="选择Redis库"></a>选择Redis库</h1><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//select db</span></span><br><span class="line">c.Do(<span class="string">"select"</span>, <span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<h1 id="set_u548Cget_key"><a href="#set_u548Cget_key" class="headerlink" title="set和get key"></a>set和get key</h1><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//set</span></span><br><span class="line">c.Do(<span class="string">"SET"</span>, <span class="string">"message1"</span>, <span class="string">"Hello World"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//get</span></span><br><span class="line">world, err := redis.String(c.Do(<span class="string">"GET"</span>, <span class="string">"message1"</span>))</span><br><span class="line"><span class="keyword">if</span> err != <span class="constant">nil</span> &#123;</span><br><span class="line">	fmt.Println(<span class="string">"key not found"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Println(world)</span><br></pre></td></tr></table></figure>
<h1 id="u5B8C_u6574_u7684_u4EE3_u7801_u5982_u4E0B"><a href="#u5B8C_u6574_u7684_u4EE3_u7801_u5982_u4E0B" class="headerlink" title="完整的代码如下"></a>完整的代码如下</h1><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">"github.com/garyburd/redigo/redis"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">func</span> main() &#123;</span><br><span class="line">	c, err := redis.Dial(<span class="string">"tcp"</span>, <span class="string">"192.168.10.12:6379"</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="constant">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> c.Close()</span><br><span class="line"></span><br><span class="line">	c.Send(<span class="string">"auth"</span>, <span class="string">"xxx"</span>)</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//select db</span></span><br><span class="line">	c.Do(<span class="string">"select"</span>, <span class="number">1</span>)</span><br><span class="line">	<span class="comment">//set</span></span><br><span class="line">	c.Do(<span class="string">"SET"</span>, <span class="string">"message1"</span>, <span class="string">"Hello World"</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">//get</span></span><br><span class="line">	world, err := redis.String(c.Do(<span class="string">"GET"</span>, <span class="string">"message1"</span>))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="constant">nil</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">"key not found"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fmt.Println(world)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>参考站点</p>
<p><a href="https://www.reddit.com/r/golang/comments/3dspr9/which_redis_client/" target="_blank" rel="external">https://www.reddit.com/r/golang/comments/3dspr9/which_redis_client/</a><br><a href="https://godoc.org/github.com/garyburd/redigo/redis" target="_blank" rel="external">https://godoc.org/github.com/garyburd/redigo/redis</a></p>
<p>have fun !</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2016-07-05T07:51:18.000Z"><a href="/2016/07/05/Golang命令行编程/">2016-07-05</a></time>
      
      
  
    <h1 class="title"><a href="/2016/07/05/Golang命令行编程/">Golang命令行编程</a></h1>
  

    </header>
    <div class="entry">
      
        <p>这几天在编写一个使用Golang发邮件的脚本,无意中找到一篇关于Golang命令行编程的文章,感觉写的很好.忍不住把它翻译出来.<br>我是边翻译边练习,一些地方不一定是直译,努力做到表达清楚即可.<br>参考文章为<a href="http://thenewstack.io/cli-command-line-programming-with-go/" target="_blank" rel="external">CLI: Command Line Programming with Go</a></p>
<p>CLI,即”command line interface”,是用户与命令行交互程序,Go作为一种静态编译语言,编译的二进制文件不需要安装依赖包,在命令行编程领域颇受欢迎.如果你写过需要安装依赖的命令行程序,就知道这是多么重要的特性了.<br>本文主要介绍Go开发CLI程序的基本内容和用到的标准库.</p>
<h1 id="Arguments_28_u53C2_u6570_29"><a href="#Arguments_28_u53C2_u6570_29" class="headerlink" title="Arguments(参数)"></a>Arguments(参数)</h1><p>CLI程序一般都有命令行参数输入,在Go中程序参数是一个slice of string<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Args []<span class="typename">string</span></span><br></pre></td></tr></table></figure></p>
<p>以下代码片段,获取当前运行程序的名字<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"os"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">func</span> main() &#123;</span><br><span class="line">    <span class="comment">// Program Name is always the first (implicit) argument</span></span><br><span class="line">    cmd := os.Args[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    fmt.Printf(<span class="string">"Program Name: %s\n"</span>, cmd)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>以上程序在code目录下,名为example1.可以如下命令build和run<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> build</span><br><span class="line">./example1</span><br></pre></td></tr></table></figure></p>
<p>可以看到如下的输出<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Program Name: ./example1</span><br></pre></td></tr></table></figure></p>
<h1 id="u5982_u4F55_u786E_u5B9A_u7A0B_u5E8F_u8F93_u5165_u53C2_u6570_u7684_u6570_u91CF"><a href="#u5982_u4F55_u786E_u5B9A_u7A0B_u5E8F_u8F93_u5165_u53C2_u6570_u7684_u6570_u91CF" class="headerlink" title="如何确定程序输入参数的数量"></a>如何确定程序输入参数的数量</h1><p>获取程序的输入参数数量,可以通过获取参数长度再减1(因为第一个参数是程序本身的名字)得到.或者,通过os.Args[1:]创建一个新的slice,这表示创建一个索引从1(不是0)开始到结束的subslice来存储参数数量<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"os"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">func</span> main() &#123;</span><br><span class="line">    argCount := <span class="built_in">len</span>(os.Args[<span class="number">1</span>:])</span><br><span class="line">    fmt.Printf(<span class="string">"Total Arguments (excluding program name): %d\n"</span>, argCount)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>以example2的名字执行./example2,获取的输入参数的数量为<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Total Arguments (excluding program name): <span class="number">0</span></span><br></pre></td></tr></table></figure></p>
<p>执行./example2 -foo=bar,获取的输入参数的数量为<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Total Arguments (excluding program name): <span class="number">1</span></span><br></pre></td></tr></table></figure></p>
<h1 id="u53C2_u6570_u5217_u8868"><a href="#u53C2_u6570_u5217_u8868" class="headerlink" title="参数列表"></a>参数列表</h1><p>以下程序片段展示了获取参数列表的方法<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"os"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">func</span> main() &#123;</span><br><span class="line">	<span class="keyword">for</span> i, a := <span class="keyword">range</span> os.Args[<span class="number">1</span>:] &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"Argument %d is %s\n"</span>, i+<span class="number">1</span>, a)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>执行<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./example3 -local u=admin --help</span><br></pre></td></tr></table></figure></p>
<p>结果<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Argument <span class="number">1</span> is -local</span><br><span class="line">Argument <span class="number">2</span> is u=admin</span><br><span class="line">Argument <span class="number">3</span> is --help</span><br></pre></td></tr></table></figure></p>
<h1 id="Flag_u5E93"><a href="#Flag_u5E93" class="headerlink" title="Flag库"></a>Flag库</h1><p>至此,我们已经知道了获取程序输入参数的基本方法,只不过以这种方式获取参数,并赋给变量使用显得非常的笨重和繁琐.可以使用Flag库解决这个问题.<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"flag"</span></span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">func</span> main() &#123;</span><br><span class="line">    <span class="keyword">var</span> port <span class="typename">int</span></span><br><span class="line">    flag.IntVar(&amp;port, <span class="string">"p"</span>, <span class="number">8000</span>, <span class="string">"specify port to use.  defaults to 8000."</span>)</span><br><span class="line">    flag.Parse()</span><br><span class="line"></span><br><span class="line">    fmt.Printf(<span class="string">"port = %d"</span>, port)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>首先,声明一个默认值是8000的int型flag.<br>再次,并通过调用flag.Parse()告知用户定义的flags.<br>执行这个程序,不添加参数,结果为port=8000,因为我们定义了port的默认值,告诉flag库,如果port没有赋值,就会使用这个默认值.<br>执行./example4 -p=9000,结果为port=9000.<br>此外,flag库提供了使用方法的帮助信息,执行./example4 -help,结果显示如下<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Usage of ./example4:</span><br><span class="line">  -p <span class="typename">int</span></span><br><span class="line">    	Specify port to use. defaults to <span class="number">8000.</span> (<span class="keyword">default</span> <span class="number">8000</span>)</span><br></pre></td></tr></table></figure></p>
<h1 id="flag-Args_28_29"><a href="#flag-Args_28_29" class="headerlink" title="flag.Args()"></a>flag.Args()</h1><p>很多CLI程序中,存在定义flag的参数,也存在没有定义flag的参数.flag.Args()能够返回没有定义flag的参数信息.<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"flag"</span></span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">func</span> main() &#123;</span><br><span class="line">    <span class="keyword">var</span> port <span class="typename">int</span></span><br><span class="line">    flag.IntVar(&amp;port, <span class="string">"p"</span>, <span class="number">8000</span>, <span class="string">"specify port to use.  defaults to 8000."</span>)</span><br><span class="line">    flag.Parse()</span><br><span class="line"></span><br><span class="line">    fmt.Printf(<span class="string">"port = %d\n"</span>, port)</span><br><span class="line">    fmt.Printf(<span class="string">"other args: %+v\n"</span>, flag.Args())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>执行这个程序, ./example5 -p=9000 foo=10 -bar<br>结果如下<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">port = <span class="number">9000</span></span><br><span class="line">other args: [foo=<span class="number">10</span> -bar]</span><br></pre></td></tr></table></figure></p>
<p>flag库当遇到没有”-“的参数后会停止搜寻flags,由于foo=10没有以”-“开头,导致其后的所有参数(包括-bar)都会被当做非选项flag.<br>这种特性使得类似command [flags] subcommand [subflags]风格的应用程序创建非常方便.</p>
<h1 id="Invalid_flag_u53C2_u6570"><a href="#Invalid_flag_u53C2_u6570" class="headerlink" title="Invalid flag参数"></a>Invalid flag参数</h1><p>Go是一种强类型语言,如果我们强制把一个string类型转换为int类型,flag会出现报错.<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"flag"</span></span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">func</span> main() &#123;</span><br><span class="line">    <span class="keyword">var</span> port <span class="typename">int</span></span><br><span class="line">    flag.IntVar(&amp;port, <span class="string">"p"</span>, <span class="number">8000</span>, <span class="string">"specify port to use.  defaults to 8000"</span>)</span><br><span class="line">    flag.Parse()</span><br><span class="line"></span><br><span class="line">    fmt.Printf(<span class="string">"port = %d"</span>, port)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>执行以上程序./example6 -p=foo<br>结果如下:<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">invalid value <span class="string">"foo"</span> <span class="keyword">for</span> flag -p: strconv.ParseInt: parsing <span class="string">"foo"</span>: invalid syntax</span><br><span class="line">Usage of ./example6:</span><br><span class="line">  -p <span class="typename">int</span></span><br><span class="line">    	specify port to use. defaults to <span class="number">8000</span> (<span class="keyword">default</span> <span class="number">8000</span>)</span><br></pre></td></tr></table></figure></p>
<p>此处不仅提示出错误,还告知正确的用法.</p>
<h1 id="flag-Usage"><a href="#flag-Usage" class="headerlink" title="flag.Usage"></a>flag.Usage</h1><p>flag库公开定义了Usage函数变量,允许我们重新定义输出信息,并用于任何我们期望使用的函数中.<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"flag"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"os"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">func</span> main() &#123;</span><br><span class="line">	flag.Usage = <span class="keyword">func</span>() &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"Usage of %s:\n"</span>, os.Args[<span class="number">0</span>])</span><br><span class="line">		fmt.Printf(<span class="string">"example7 file1 file2 ...\n"</span>)</span><br><span class="line">		flag.PrintDefaults()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	flag.Parse()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>执行以上程序./example7 -help<br>结果如下<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Usage of ./example7:</span><br><span class="line">example7 file1 file2 ...</span><br></pre></td></tr></table></figure></p>
<h1 id="u83B7_u53D6_u8F93_u5165"><a href="#u83B7_u53D6_u8F93_u5165" class="headerlink" title="获取输入"></a>获取输入</h1><p>目前为止,程序运行后,我们获得了输出结果,但没有获取输入信息.我们可以通过stdin和fmt.Scanf捕捉到一些基本的输入信息<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">func</span> main() &#123;</span><br><span class="line">    <span class="keyword">var</span> guessColor <span class="typename">string</span></span><br><span class="line">    <span class="keyword">const</span> favColor = <span class="string">"blue"</span></span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">"Guess my favorite color:"</span>)</span><br><span class="line">        <span class="keyword">if</span> _, err := fmt.Scanf(<span class="string">"%s"</span>, &amp;guessColor); err != <span class="constant">nil</span> &#123;</span><br><span class="line">            fmt.Printf(<span class="string">"%s\n"</span>, err)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> favColor == guessColor &#123;</span><br><span class="line">            fmt.Printf(<span class="string">"%q is my favorite color!"</span>, favColor)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        fmt.Printf(<span class="string">"Sorry, %q is not my favorite color.  Guess again.\n"</span>, guessColor)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="bufio-Scanner"><a href="#bufio-Scanner" class="headerlink" title="bufio.Scanner"></a>bufio.Scanner</h1><p>fmt.Scanf能够获取一些简单的输入,bufio.Scanner能够一次性获取整行的输入<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"bufio"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"os"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">func</span> main() &#123;</span><br><span class="line">	scanner := bufio.NewScanner(os.Stdin)</span><br><span class="line">	<span class="keyword">for</span> scanner.Scan() &#123;</span><br><span class="line">		line := scanner.Text()</span><br><span class="line">		<span class="keyword">if</span> line == <span class="string">"exit"</span> &#123;</span><br><span class="line">			os.Exit(<span class="number">0</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		fmt.Println(line) <span class="comment">//	Println will add back the final `\n`</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := scanner.Err(); err != <span class="constant">nil</span> &#123;</span><br><span class="line">		fmt.Fprintln(os.Stderr, <span class="string">"reading standard input:"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这是一个简单的echo程序,输入exit后退出.</p>
<h1 id="u7F16_u5199_u4E00_u4E2Acat_u7A0B_u5E8F"><a href="#u7F16_u5199_u4E00_u4E2Acat_u7A0B_u5E8F" class="headerlink" title="编写一个cat程序"></a>编写一个cat程序</h1><p>cat是Linux下常用的一个命令,我们通过本文所学,编写一个简版的cat.<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"flag"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"io"</span></span><br><span class="line">	<span class="string">"os"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">func</span> main() &#123;</span><br><span class="line">	flag.Usage = <span class="keyword">func</span>() &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"Usage of %s:\n"</span>, os.Args[<span class="number">0</span>])</span><br><span class="line">		fmt.Printf(<span class="string">"cat file1 file2 ...\n"</span>)</span><br><span class="line">		flag.PrintDefaults()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	flag.Parse()</span><br><span class="line">	<span class="keyword">if</span> flag.NArg() == <span class="number">0</span> &#123;</span><br><span class="line">		flag.Usage()</span><br><span class="line">		os.Exit(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, fn := <span class="keyword">range</span> flag.Args() &#123;</span><br><span class="line">		f, err := os.Open(fn)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="constant">nil</span> &#123;</span><br><span class="line">			<span class="built_in">panic</span>(err)</span><br><span class="line">		&#125;</span><br><span class="line">		_, err = io.Copy(os.Stdout, f)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="constant">nil</span> &#123;</span><br><span class="line">			<span class="built_in">panic</span>(err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="Help_21"><a href="#Help_21" class="headerlink" title="Help!"></a>Help!</h1><p>如前文所述,如果没有定义help参数,默认已经有了.<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-h</span><br><span class="line">--h</span><br><span class="line">-help</span><br><span class="line">--help</span><br></pre></td></tr></table></figure></p>
<p>使用哪种形式的help取决于flag的初始化解析方式,在flag库中,长短形式的参数是一致的.</p>
<h1 id="u603B_u7ED3"><a href="#u603B_u7ED3" class="headerlink" title="总结"></a>总结</h1><p>基于Go的CLI程序有很多的选项.我们只是介绍了一些基本用法,更多的信息请阅读以下库文件</p>
<ul>
<li>flag Package</li>
<li>bufio Package</li>
<li>fmt Package</li>
</ul>
<h1 id="u9644_u52A0_u7684command_line_libraries"><a href="#u9644_u52A0_u7684command_line_libraries" class="headerlink" title="附加的command line libraries"></a>附加的command line libraries</h1><p>有一些第三方的库用来简化cli程序编写,推荐查阅</p>
<ul>
<li>comandante</li>
<li>viper</li>
</ul>
<p>参考站点</p>
<p><a href="http://thenewstack.io/cli-command-line-programming-with-go/" target="_blank" rel="external">http://thenewstack.io/cli-command-line-programming-with-go/</a></p>
<p>PS: 本文的练习代码git仓库地址为</p>
<p><a href="https://github.com/wfirooooooo/go_cli_example.git" target="_blank" rel="external">https://github.com/wfirooooooo/go_cli_example.git</a></p>
<p>have fun !</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2016-06-23T08:08:22.000Z"><a href="/2016/06/23/使用Perf和FlameGraph进行系统性能分析/">2016-06-23</a></time>
      
      
  
    <h1 class="title"><a href="/2016/06/23/使用Perf和FlameGraph进行系统性能分析/">使用Perf和FlameGraph进行系统性能分析</a></h1>
  

    </header>
    <div class="entry">
      
        <p>Perf是一款Linux平台的系统性能诊断和分析工具,通过它可以查看应用程序的运行性能,只是在图形方面表现的不足,好在有Flame Graph.Flame Graph能够把Perf采集的数据转换为svg矢量图.<br>本文就简单说说它们的用法.</p>
<p><strong>Perf</strong></p>
<ol>
<li><p>Perf安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y perf</span><br></pre></td></tr></table></figure>
</li>
<li><p>Perf使用</p>
</li>
</ol>
<ul>
<li>perf list<br>  列出所有perf能够采样点的事件</li>
<li>perf stat<br>  以精简的方式提供被调试程序的整体情况和汇总数据</li>
<li>perf top<br>  列出所有进程,实时显示统计信息</li>
<li>perf record<br>  记录单个函数级别的统计信息</li>
<li>perf report<br>  显示统计结果</li>
</ul>
<p><strong>Flame Graph</strong><br>FLame Graph其实是一组perl脚本,用以将perf等工具获取的原始采样数据转换为Flame Graph能够识别的文件格式,除了perf,还支持Dtrace,Systemtap以及XCode Instruments等工具.<br>Flame Graph能够生成svg矢量图,X轴代表采样总量,Y轴代表栈深度.每个框代表一个栈里的函数,宽度代表占用CPU的总时间.较宽的框表示该函数运行时间较慢或调用次数较多,从而占用CPU时间多.</p>
<ul>
<li>Flame Graph脚本列表<blockquote>
<p>flamegraph.pl<br>stackcollapse-elfutils.pl<br>stackcollapse-gdb.pl<br>stackcollapse-instruments.pl<br>stackcollapse-jstack.pl<br>stackcollapse-perf.pl<br>stackcollapse.pl<br>stackcollapse-pmc.pl<br>stackcollapse-recursive.pl<br>stackcollapse-stap.pl<br>stackcollapse-vtune.pl</p>
</blockquote>
</li>
</ul>
<p><strong>使用示例</strong></p>
<ol>
<li><p>使用perf record生成采样数据perf.data</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perf record <span class="operator">-a</span> -g</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用perf script对perf.data进行解析</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perf script -i perf.data &amp;&gt; perf.unfold</span><br></pre></td></tr></table></figure>
</li>
<li><p>将perf.unfold中的符号进行折叠</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./stackcollapse-perf.pl perf.unfold &amp;&gt; perf.folded</span><br></pre></td></tr></table></figure>
</li>
<li><p>生成svg图</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./flamegraph.pl perf.folded &gt; perf.svg</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><strong>参考站点</strong></p>
<p><a href="https://www.ibm.com/developerworks/cn/linux/l-cn-perf1" target="_blank" rel="external">https://www.ibm.com/developerworks/cn/linux/l-cn-perf1</a><br><a href="https://github.com/brendangregg/FlameGraph" target="_blank" rel="external">https://github.com/brendangregg/FlameGraph</a><br><a href="http://kernel.taobao.org/index.php?title=Documents/Perf_flame_graph" target="_blank" rel="external">http://kernel.taobao.org/index.php?title=Documents/Perf_flame_graph</a><br><a href="http://unix.stackexchange.com/questions/14227/do-i-need-root-admin-permissions-to-run-userspace-perf-tool-perf-events-ar" target="_blank" rel="external">http://unix.stackexchange.com/questions/14227/do-i-need-root-admin-permissions-to-run-userspace-perf-tool-perf-events-ar</a><br><a href="https://gist.github.com/trevnorris/9616784" target="_blank" rel="external">https://gist.github.com/trevnorris/9616784</a><br><a href="http://www.infoq.com/cn/news/2015/08/java-flamegraph" target="_blank" rel="external">http://www.infoq.com/cn/news/2015/08/java-flamegraph</a></p>
<p>have fun !</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2016-06-20T07:27:24.000Z"><a href="/2016/06/20/Nginx配置模板/">2016-06-20</a></time>
      
      
  
    <h1 class="title"><a href="/2016/06/20/Nginx配置模板/">Nginx配置模板</a></h1>
  

    </header>
    <div class="entry">
      
        <p>工作中用Nginx的地方很多,每次部署好后都面临Nginx的配置问题.这里把工作中用到的Nginx配置整理成模板,方便今后查阅.</p>
<p>Nginx配置文件分为3种:</p>
<ol>
<li>Nginx主配置文件<ul>
<li>nginx.conf   包含全局配置</li>
</ul>
</li>
<li>Server配置文件<ul>
<li>server.conf  包含server访问规则</li>
</ul>
</li>
<li>Upstream配置文件<ul>
<li>upstream.conf    包含后端服务器信息 </li>
</ul>
</li>
</ol>
<p>各个文件内容如下:</p>
<p><strong>nginx.conf</strong><br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user  nginx nginx ;&#10;worker_processes  auto;&#10;#error_log  logs/error.log;&#10;pid        logs/nginx.pid;&#10;worker_rlimit_nofile 102400;&#10;&#10;events &#123;&#10;use epoll;&#10;multi_accept on;&#10;worker_connections 10240;&#10;&#125;&#10;&#10;http &#123;&#10;include mime.types;&#10;default_type  application/octet-stream;&#10;charset UTF-8;&#10;log_format  main  &#39;$remote_addr - $remote_user [$time_local] &#34;$request&#34; &#39;&#10;                  &#39;$status $body_bytes_sent &#34;$http_referer&#34; &#39;&#10;                  &#39;&#34;$http_user_agent&#34; &#34;$http_x_forwarded_for&#34;&#39; &#39;$request_time&#39; &#39;$upstream_addr&#39;;&#10;#access_log  logs/access.log  main;&#10;sendfile        on;&#10;tcp_nopush     on;&#10;server_tokens off;&#10;keepalive_timeout  65;&#10;&#10;gzip on;&#10;gzip_proxied any;&#10;gzip_comp_level 4;&#10;gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;&#10;gzip_min_length 1k;&#10;gzip_buffers 4 16k;&#10;gzip_http_version 1.1;&#10;gzip_vary on;&#10;&#10;client_max_body_size 10m;&#10;client_body_buffer_size 128k;&#10;&#10;proxy_connect_timeout 60;&#9;&#10;proxy_read_timeout 60;&#10;proxy_send_timeout 60;&#10;proxy_buffer_size 16k;&#10;proxy_buffers 4 32k;&#10;proxy_busy_buffers_size&#160;64k;&#160;&#10;proxy_temp_file_write_size&#160;128k;&#160;&#10;&#10;#include&#25991;&#20214;&#36335;&#24452;&#20197;&#23454;&#38469;&#36335;&#24452;&#20026;&#20934;&#10;include /app/nginx/conf/vhost/server.conf;&#10;include /app/nginx/conf/vhost/upstream.conf;&#10;&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>server.conf</strong><br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server &#123;&#10;listen       80;&#9;                            #or  ip:port&#10;server_name localhost;&#9;                        #or domain or ip&#10;access_log  logs/localhost_access.log  main;&#9;#Change the log file name identifide by the servername&#10;error_log  logs/localhost_error.log;&#10;&#10;location / &#123;&#10;&#9;proxy_set_header Host $host;&#10;    proxy_set_header X-Forwarded-For $http_x_forwarded_for;&#10;    #proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;&#10;    proxy_pass http://server_pool;&#10;&#125;&#10;&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>upstream.conf</strong><br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">upstream server_pool &#123;&#10;    #ip_hash;&#10;&#9;server&#9;realserver_ip_1:8080 weight=10 max_fails=2 fail_timeout=30s;&#10;&#9;server&#9;realserver_ip_2:8080 weight=10 max_fails=2 fail_timeout=30s;&#10;&#9;server&#9;realserver_ip_3:8080 weight=10 max_fails=2 fail_timeout=30s;&#10;&#125;</span><br></pre></td></tr></table></figure></p>
<p>have fun !</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2016-06-03T06:39:09.000Z"><a href="/2016/06/03/sysbench配置和示例/">2016-06-03</a></time>
      
      
  
    <h1 class="title"><a href="/2016/06/03/sysbench配置和示例/">sysbench配置和示例</a></h1>
  

    </header>
    <div class="entry">
      
        <p>sysbench是一款评价操作系统性能的压测工具,主要用于数据库服务的性能压测.<br>本文简单介绍一些它的使用方法.</p>
<p><strong>压测性能参数</strong></p>
<ul>
<li>文件I/O性能</li>
<li>调度性能</li>
<li>内存分配和传输速度</li>
<li>线程执行性能</li>
<li>数据库服务性能</li>
</ul>
<p><strong>安装</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">yum install mysql-devel</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/akopytov/sysbench.git</span><br><span class="line"><span class="built_in">cd</span> sysbench</span><br><span class="line">./autogen.sh</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure></p>
<p><strong>使用方法</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench [common-options] --test=name [<span class="built_in">test</span>-options] <span class="built_in">command</span></span><br></pre></td></tr></table></figure></p>
<p><em>command说明</em></p>
<ul>
<li>prepare   执行准备动作,为fileio压测准备文件,为db压测准备测试数据</li>
<li>run          执行实际压测动作</li>
<li>cleanup   执行完成后清除临时数据</li>
<li>help      帮助信息</li>
</ul>
<p><em>options说明</em></p>
<ul>
<li>–num-threads         压测所用工作线程数,默认值1</li>
<li>–max-requests        请求数上限,0表示不限制,默认值10000</li>
<li>–max-time            执行时间上限,0表示不限制,默认值0</li>
<li>–thread-stack-size   每个线程的stack大小,默认值32K</li>
<li>–init-rng            压测之前是否初始化随机数生成器,默认off</li>
<li>–report-interval     统计信息显示时间间隔,默认0,不开启</li>
<li>–test            压测运行的名称,必须值</li>
<li>–debug           打印debug信息,默认off</li>
<li>–validate        压测结果确认,默认off</li>
<li>–help            打印帮助信息,默认off</li>
<li>–verbosity       信息显示等级,0-critical级信息,5-debug级信息,默认4</li>
<li>–percentile      sysbench执行时间包括请求的最短时间,平均时间,最长时间.此项可设置采用的请求百分比范围做统计,默认95</li>
</ul>
<p><strong>示例</strong></p>
<ul>
<li><p>cpu测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#单线程</span></span><br><span class="line">sysbench --test=cpu --num-threads=<span class="number">1</span> --cpu-max-prime=<span class="number">5000</span> run</span><br><span class="line"><span class="comment">#多线程</span></span><br><span class="line">sysbench --test=cpu --num-threads=<span class="number">4</span> --cpu-max-prime=<span class="number">20000</span> run</span><br></pre></td></tr></table></figure>
</li>
<li><p>内存测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench --test=memory --num-threads=<span class="number">1</span> --memory-block-size=<span class="number">4096</span> --memory-total-size=<span class="number">1</span>G run</span><br></pre></td></tr></table></figure>
</li>
<li><p>fileio测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#准备文件</span></span><br><span class="line">sysbench --test=fileio --file-total-size=<span class="number">400</span>M prepare</span><br><span class="line"><span class="comment">#随机读写模式</span></span><br><span class="line">sysbench --test=fileio --file-total-size=<span class="number">400</span>M --file-test-mode=rndrw --init-rng=on --max-time=<span class="number">300</span> --max-requests=<span class="number">0</span> run</span><br></pre></td></tr></table></figure>
</li>
<li><p>mysql测试(lua文件以sysbench源码实际路径为准)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#准备测试数据,创建表,插入100w数据</span></span><br><span class="line">sysbench --test=/usr/<span class="built_in">local</span>/src/sysbench/sysbench/tests/db/oltp.lua \</span><br><span class="line">              --mysql-host=host \</span><br><span class="line">              --mysql-port=<span class="number">9696</span> \</span><br><span class="line">              --mysql-user=kingshard \</span><br><span class="line">              --mysql-password=kingshard \</span><br><span class="line">              --mysql-db=kingshard \</span><br><span class="line">              --oltp-tables-count=<span class="number">1</span> \</span><br><span class="line">              --oltp-table-size=<span class="number">1000000</span> \</span><br><span class="line">              --num-threads=<span class="number">50</span> \</span><br><span class="line">              --max-requests=<span class="number">1000000</span> \</span><br><span class="line">              --report-interval=<span class="number">1</span> \</span><br><span class="line">              prepare</span><br><span class="line"><span class="comment">#测试select</span></span><br><span class="line">sysbench --test=/usr/<span class="built_in">local</span>/src/sysbench/sysbench/tests/db/select.lua \</span><br><span class="line">              --mysql-host=host \</span><br><span class="line">              --mysql-port=<span class="number">9696</span> \</span><br><span class="line">              --mysql-user=kingshard \</span><br><span class="line">              --mysql-password=kingshard \</span><br><span class="line">              --mysql-db=kingshard \</span><br><span class="line">              --oltp-tables-count=<span class="number">1</span> \</span><br><span class="line">              --oltp-table-size=<span class="number">1000000</span> \</span><br><span class="line">              --num-threads=<span class="number">16</span> \</span><br><span class="line">              --max-requests=<span class="number">1000000</span> \</span><br><span class="line">              --report-interval=<span class="number">1</span> \</span><br><span class="line">              --max-time=<span class="number">20</span> \</span><br><span class="line">              run</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>参考站点<br><a href="https://github.com/akopytov/sysbench" target="_blank" rel="external">https://github.com/akopytov/sysbench</a><br><a href="http://mingxinglai.com/cn/2013/07/sysbench/" target="_blank" rel="external">http://mingxinglai.com/cn/2013/07/sysbench/</a><br><a href="https://github.com/flike/kingshard/blob/master/doc/KingDoc/kingshard_performance_test.md" target="_blank" rel="external">https://github.com/flike/kingshard/blob/master/doc/KingDoc/kingshard_performance_test.md</a><br><a href="http://blog.csdn.net/lidan3959/article/details/36876517" target="_blank" rel="external">http://blog.csdn.net/lidan3959/article/details/36876517</a></p>
<p>have fun !</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2016-05-31T09:53:20.000Z"><a href="/2016/05/31/使用Keepalived实现Redis高可用/">2016-05-31</a></time>
      
      
  
    <h1 class="title"><a href="/2016/05/31/使用Keepalived实现Redis高可用/">使用Keepalived实现Redis高可用</a></h1>
  

    </header>
    <div class="entry">
      
        <p>本文通过Keepalived配置和编写Redis切换脚本实现Redis服务的高可用,实现Redis主从的自动切换.</p>
<p>Redis和Keepalived的安装 略</p>
<p>实验环境如下:<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Keepalived/Redis Master     192.168.10.12&#10;Keepalived/Redis Slave      192.168.10.13    &#10;VIP                         192.168.10.150</span><br></pre></td></tr></table></figure></p>
<p>Redis Master(192.168.10.12)上的Keepalived配置/etc/keepalived/keepalived.conf<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">! Configuration File for keepalived&#10;global_defs &#123;&#10;    lvs_id LVS_redis&#10;&#125;&#10;vrrp_script chk_redis &#123;&#10;    script &#34;/etc/keepalived/scripts/redis_check.sh&#34;  &#10;    interval 2                                     &#10;&#125;&#10;vrrp_instance VI_1 &#123;&#10;    state BACKUP&#10;    interface eth1&#10;    virtual_router_id 51&#10;    priority 100&#10;    advert_int 1&#10;    nopreempt&#10;    authentication &#123;&#10;        auth_type PASS&#10;        auth_pass 1111&#10;    &#125;&#10;    track_script &#123;&#10;         chk_redis &#10;    &#125;&#10;    virtual_ipaddress &#123;&#10;        192.168.10.150&#10;    &#125;&#10;        notify_master &#34;/etc/keepalived/scripts/redis.sh -m&#34;&#10;        notify_backup &#34;/etc/keepalived/scripts/redis.sh -s&#34;&#10;        notify_fault  &#34;/etc/keepalived/scripts/redis.sh -s&#34;&#10;        notify_stop  &#34;/etc/keepalived/scripts/redis.sh -s&#34;&#10;&#125;</span><br></pre></td></tr></table></figure></p>
<p>各脚本文件按照实际情况配置:</p>
<p><strong>redis_check.sh</strong><br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash &#10;REDISCLI=/usr/local/bin/redis-cli&#10;REDISPORT=6379&#10;ALIVE=`$REDISCLI -p $REDISPORT PING` &#10;if [ &#34;$ALIVE&#34; == &#34;PONG&#34; ]; then&#10;echo $ALIVE &#10;exit 0 &#10;else&#10;echo $ALIVE &#10;exit 1 &#10;fi</span><br></pre></td></tr></table></figure></p>
<p><strong>redis.sh</strong><br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash&#10;#&#10;#Script start Redis and promote to MASTER/SLAVE&#10;#(The MIT License)&#10;#Copyright (C) 2011 Alex Williams&#10;#Modified by wong 2016&#10;#&#10;# Usage Options:&#10;#   -m    promote the redis-server to MASTER&#10;#   -s    promote the redis-server to SLAVE&#10;#   -k    start the redis-server and promote it to MASTER&#10;#&#10;#########################&#10;# User Defined Variables&#10;#########################&#10;REDIS_PEER_IP=&#34;192.168.10.13&#34;                                       # Redis MASTER ip&#10;REDIS_PORT=&#34;6379&#34;                                                   # Redis MASTER port&#10;REDIS_COMMANDS=&#34;/usr/local/bin/redis-cli -p $REDIS_PORT&#34;            # The location of the redis binary&#10;DAEMON=/usr/local/bin/redis-server&#10;DAEMON_ARGS=/etc/redis/$&#123;REDIS_PORT&#125;.conf&#10;##############&#10;# Exit Codes&#10;##############&#10;E_INVALID_ARGS=65&#10;E_INVALID_COMMAND=66&#10;E_NO_SLAVES=67&#10;E_DB_PROBLEM=68&#10;##########################&#10;# Script Functions&#10;##########################&#10;error() &#123;&#10;        E_CODE=$?&#10;        echo &#34;Exiting: ERROR $&#123;E_CODE&#125;: $E_MSG&#34;&#10;        exit $E_CODE&#10;&#125;&#10;start_redis() &#123;&#10;      alive=`$&#123;REDIS_COMMANDS&#125; PING`&#10;      if [ &#34;$alive&#34; != &#34;PONG&#34; ]; then&#10;        $&#123;DAEMON&#125; $&#123;DAEMON_ARGS&#125;&#10;        sleep 1&#10;      fi&#10;&#125;&#10;start_master() &#123;&#10;    $&#123;REDIS_COMMANDS&#125; SLAVEOF $&#123;REDIS_PEER_IP&#125; $&#123;REDIS_PEER_PORT&#125;&#10;    sleep 10&#10;        $&#123;REDIS_COMMANDS&#125; SLAVEOF no one&#10;&#125;&#10;start_slave() &#123;&#10;        $&#123;REDIS_COMMANDS&#125; SLAVEOF $&#123;REDIS_PEER_IP&#125; $&#123;REDIS_PORT&#125;&#10;&#125;&#10;usage() &#123;&#10;        echo  &#34;Start Redis and promote to MASTER/SLAVE  &#34;&#10;        echo  &#34;Options: &#34;&#10;        echo  &#34;-m promote the redis-server to MASTER&#34;&#10;        echo  &#34;-s promote the redis-server to SLAVE&#34;&#10;        echo  &#34;-k start the redis-server and promote it to MASTER&#34;&#10;        echo  &#34;&#34;&#10;        exit $E_INVALID_ARGS&#10;&#125;&#10;for arg in &#34;$@&#34;&#10;do&#10;        case $arg in&#10;        -m) arg_m=true;;&#10;        -s) arg_s=true;;&#10;        -k) arg_k=true;;&#10;        *) usage;;&#10;        esac&#10;done&#10;if [ $arg_m ]; then&#10;        echo  &#34;Promoting redis-server to MASTER&#34;&#10;        start_redis&#10;        wait&#10;        start_master&#10;elif [ $arg_s ]; then&#10;        echo  &#34;Promoting redis-server to SLAVE&#34;&#10;        start_redis&#10;        wait&#10;        start_slave&#10;elif [ $arg_k ]; then&#10;        echo  &#34;Starting redis-server and promoting to MASTER&#34;&#10;        start_redis&#10;        wait&#10;        start_master&#10;else&#10;        usage&#10;fi</span><br></pre></td></tr></table></figure></p>
<p>Redis Slave(192.168.10.13)上的Keepalived配置/etc/keepalived/keepalived.conf<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">! Configuration File for keepalived&#10;global_defs &#123;&#10;    lvs_id LVS_redis&#10;&#125;&#10;vrrp_script chk_redis &#123;&#10;    script &#34;/etc/keepalived/scripts/redis_check.sh&#34;  &#10;    interval 2                                     &#10;&#125;&#10;vrrp_instance VI_1 &#123;&#10;    state BACKUP&#10;    interface eth1&#10;    virtual_router_id 51&#10;    priority 90&#10;    advert_int 1&#10;    authentication &#123;&#10;        auth_type PASS&#10;        auth_pass 1111&#10;    &#125;&#10;    track_script &#123;&#10;         chk_redis &#10;    &#125;&#10;    virtual_ipaddress &#123;&#10;        192.168.10.150&#10;    &#125;&#10;    notify_master &#34;/etc/keepalived/scripts/redis.sh -m&#34;&#10;    notify_backup &#34;/etc/keepalived/scripts/redis.sh -s&#34;&#10;    notify_fault  &#34;/etc/keepalived/scripts/redis.sh -s&#34;&#10;    notify_stop  &#34;/etc/keepalived/scripts/redis.sh -s&#34;&#10;&#125;</span><br></pre></td></tr></table></figure></p>
<p>Redis Slave上的redis_check.sh与Redis Master上的一致,redis.sh不同的地方只有ip</p>
<p>备注<br>1 由于keepalived两个都设置了backup,并且是非抢占模式,启动keepalived的前提是:<br>(1) 保持redis主从数据一致.<br>2 脚本中redis-cli的指令需要用绝对路径,或者在脚本中加载环境变量,否则脚本无法生效.<br>3 停掉keepalived或redis都会导致vip的漂移.</p>
<p>参考站点<br><a href="https://aricgardner.com/databases/redis/redis-with-replication-and-failover-keepalived/" target="_blank" rel="external">https://aricgardner.com/databases/redis/redis-with-replication-and-failover-keepalived/</a></p>
<p>have fun !</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2016-05-31T03:56:01.000Z"><a href="/2016/05/31/kingshard文档笔记记录/">2016-05-31</a></time>
      
      
  
    <h1 class="title"><a href="/2016/05/31/kingshard文档笔记记录/">kingshard文档笔记记录</a></h1>
  

    </header>
    <div class="entry">
      
        <p>安装golang<br>配置文件默认读取/etc/ks.yaml,启动的时候可以指定./bin/kingshard -config=etc/ks.yaml<br>配置文件是yaml方式解析,不允许出现tab健,且冒号后跟空格.<br>yaml文件验证网站<a href="http://www.yamllint.com/" target="_blank" rel="external">http://www.yamllint.com/</a></p>
<p>分表规则:<br>支持两种分表规则: hash和range<br>分表所涉及到的子表,需要手动创建好.格式为: table<em>name</em>%4d<br>未分表的SQL语句将发送到默认节点.</p>
<p>后台运行kingshard建议使用supervisor工具</p>
<p>当更新操作涉及到多个node时,kingshard会以非事务的方式执行跨node操作.为了保证数据一致性,请根据实际需求使用非事务方式的跨node更新操作.</p>
<p>可以指定sql发送的node,需要在sql语句前面加上包含node名称的注释(mysql在连接时需要加上-c选项,避免客户端过滤掉注释)</p>
<p>强制读主库<br>有时候主库插入数据后,希望立即从主库读出,可以在select语句中加入相应的注释项(/<em>master</em>/),就可以将select语句发送到主库.</p>
<p>支持跨node的sum和count函数</p>
<p>支持跨node的order by语句</p>
<p>支持单node的事务,出现跨node的事务,会返回错误.可以在同node上跨不同子表.</p>
<p>管理端命令以命令行方式提供,通过关键字标示,格式分两类<br>admin server(opt,k,v) values(action,k1,v1).操作整个kingshard,opt表示操作动作,k表示操作对象,v表示给对象的赋值.<br>admin node(opt,k,v) values(action,nodeName,k1,v1).表示操作node,opt表示操作动作,node表示节点,k表示操作对象,v表示对象赋值.<br>功能介绍: 平滑上下线后端DB,查看修改kingshard配置</p>
<p>kingshard分表方案采用二级映射的方式:<br>1 可以将表分为多个子表<br>2 将shardkey通过hash或range方式定位到其要操作的记录在哪张子表上<br>3 子表落在哪个node上通过配置文件设置</p>
<p>sharding支持insert,delete,select,update和replace语句,都支持跨子表.写操作只支持单node上跨子表.select可以跨node,跨子表.</p>
<p>sharding方式<br>range方式    基于整数范围划分来得到子表下标.基于范围的查询和更新速度快,存在热数据压力落到一张子表的问题.<br>hash方式    采用shardkey%子表个数的方式得到子表下标.请求分布均匀,基于范围的查询和更新,需要请求发送到所有子表,对性能有一定影响.</p>
<p>子表迁移方案<br>动态迁移子表,保证MySQL节点负载压力不要太大.<br>1 通过自动数据迁移工具<br>2 数据差异小于某一临界值,阻塞老子表写操作<br>3 等待新子表数据同步完毕<br>4 更改kingshard配置中对应子表路由规则<br>5 删除老节点子表</p>
<p>按时间分表<br>支持的MySQL时间类型<br>date类型:    格式YYYY-MM-DD<br>datetime类型:    格式YYYY-MM-DD HH:MM:SS<br>timestamp类型:    整数类型<br>配置文件示例<br>按年分表<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">table: test_shard_year&#10;key: id&#10;type: date_year&#10;nodes: [node1,node2]&#10;date_range: [2015-2016,2017-2018]</span><br></pre></td></tr></table></figure></p>
<p>注意:    子表命名格式必须是shard_table_YYYY</p>
<p>按月分表<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">table: test_shard_month&#10;key: ctime&#10;type: date_month&#10;nodes: [node1,node2]&#10;date_range: [201512-201602,201609-2016010]</span><br></pre></td></tr></table></figure></p>
<p>注意:    子表命名格式必须是shard_table_YYYYMM</p>
<p>按天分表<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">table: test_shard_day&#10;key: ctime&#10;type: date_day&#10;nodes: [node1,node2]&#10;date_range: [20151222-20151224,20160901-20160902]</span><br></pre></td></tr></table></figure></p>
<p>注意:    子表命名格式必须是shard_table_YYYYMMDD</p>
<p>管理端命令<br>复用了工作端口,通过特定的关键字来标示,具体操作参考    <a href="https://github.com/flike/kingshard/blob/master/doc/KingDoc/admin_command_introduce.md" target="_blank" rel="external">管理端命令</a></p>
<p>SQL黑名单功能<br>可在配置中添加SQL黑名单功能<br>blacklist_sql_file: /Users/flike/blacklist<br>在blacklist文件中定义SQL黑名单即可<br>黑名单SQL以正则表达式的形式定义,SQL中的值用?或?+代替.使用前最好手动验证.<br>示例:<br>select count(<em>) from test_shard_hash where id &gt; ?(要严格匹配大于号后面的空格)<br>select count(</em>) from test_shard_range<br>SELECT * FROM WORLD<br>DELETE FROM WORLD</p>
<p>性能优化网络篇<br>通过go语言的pprof工具查看函数耗时情况<br>下载性能分析封装库profile<br>在main函数中添加cpu监控的启动和停止入口<br>使用sysbench进行压测<br>使用pprof生成pdf报告</p>
<p>参考站点:<br><a href="https://github.com/flike/kingshard/blob/master/README_ZH.md" target="_blank" rel="external">https://github.com/flike/kingshard/blob/master/README_ZH.md</a></p>
<p>have fun !</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>





<nav id="pagination">
  
  
    <a href="/page/2/" class="alignright next">下一頁</a>
  
  <div class="clearfix"></div>
</nav></div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜尋">
    <input type="hidden" name="q" value="site:wfirooooooo.github.io">
  </form>
</div>

  

  
<div class="widget tag">
  <h3 class="title">標籤</h3>
  <ul class="entry">
  
    <li><a href="/tags/activemq/">activemq</a><small>1</small></li>
  
    <li><a href="/tags/ansible/">ansible</a><small>2</small></li>
  
    <li><a href="/tags/bot/">bot</a><small>1</small></li>
  
    <li><a href="/tags/docker/">docker</a><small>1</small></li>
  
    <li><a href="/tags/git/">git</a><small>1</small></li>
  
    <li><a href="/tags/golang/">golang</a><small>2</small></li>
  
    <li><a href="/tags/java/">java</a><small>1</small></li>
  
    <li><a href="/tags/keepalived/">keepalived</a><small>1</small></li>
  
    <li><a href="/tags/linux/">linux</a><small>1</small></li>
  
    <li><a href="/tags/lvs/">lvs</a><small>1</small></li>
  
    <li><a href="/tags/markdown/">markdown</a><small>1</small></li>
  
    <li><a href="/tags/mha/">mha</a><small>1</small></li>
  
    <li><a href="/tags/mysql/">mysql</a><small>4</small></li>
  
    <li><a href="/tags/nfs/">nfs</a><small>1</small></li>
  
    <li><a href="/tags/nginx/">nginx</a><small>1</small></li>
  
    <li><a href="/tags/openvpn/">openvpn</a><small>2</small></li>
  
    <li><a href="/tags/redis/">redis</a><small>2</small></li>
  
    <li><a href="/tags/shell/">shell</a><small>1</small></li>
  
    <li><a href="/tags/solr/">solr</a><small>1</small></li>
  
    <li><a href="/tags/sysbench/">sysbench</a><small>1</small></li>
  
    <li><a href="/tags/tmux/">tmux</a><small>1</small></li>
  
    <li><a href="/tags/tomcat/">tomcat</a><small>1</small></li>
  
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2016 wfir
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>