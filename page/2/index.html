<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>第 2 頁 | wfir&#39;s tech blog</title>
  <meta name="author" content="wfir">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="wfir&#39;s tech blog"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="wfir&#39;s tech blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">wfir&#39;s tech blog</a></h1>
  <h2><a href="/"></a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper">
  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2016-05-19T09:57:14.000Z"><a href="/2016/05/19/常用JVM性能调优监控工具示例/">2016-05-19</a></time>
      
      
  
    <h1 class="title"><a href="/2016/05/19/常用JVM性能调优监控工具示例/">常用JVM性能调优监控工具示例</a></h1>
  

    </header>
    <div class="entry">
      
        <p><strong>jps</strong><br>输出JVM中运行的状态信息<br>参数详解<br>-q 不输出类名、Jar名和传入main方法的参数<br>-m 输出传入main方法的参数<br>-l 输出main类或Jar的全限名<br>-v 输出传入JVM的参数<br>示例<br>jps -m -l</p>
<p><strong>jstack</strong><br>查看Java进程中的线程堆栈信息<br>参数详解<br>-l long listings，会打印出额外的锁信息，在发生死锁时可以用jstack -l pid来观察锁持有情况<br>-m mixed mode，不仅会输出Java堆栈信息，还会输出C/C++堆栈信息（比如Native方法）<br>示例<br>jstack -l PID</p>
<p><strong>jmap和jhat</strong><br>jmap用于查看堆内存使用情况,一般结合jhat使用<br>参数详解<br>-histo[:live]        打印java对象堆直方图,如果带live参数,只打印存活的对象数量<br>-permstat            打印持久代统计信息<br>-finalizerinfo       打印等待终止对象信息<br>-dump:<dump-options> 输出hprof数据到指定文件<br>-J<flag>             标示运行时系统架构<br>示例<br>jmap -permstat pid    打印进程的类加载器和类加载器加载的持久代对象信息<br>jmap -heap pid    查看进程堆内存使用情况<br>jmap -histo[:live] pid    查看堆内存中的对象数目、大小统计直方图<br>jmap -dump:format=b,file=dumpFileName pid    把进程内存使用情况dump到文件中，再用jhat分析查看<br>jhat -J-mx512m -port 9998 dumpFileName</flag></dump-options></p>
<p>参考站点<br><a href="http://my.oschina.net/feichexia/blog/196575" target="_blank" rel="external">http://my.oschina.net/feichexia/blog/196575</a><br><a href="http://docs.oracle.com/javase/7/docs/technotes/tools/share/jstack.html" target="_blank" rel="external">http://docs.oracle.com/javase/7/docs/technotes/tools/share/jstack.html</a></p>
<p>have fun !</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2016-05-12T08:36:23.000Z"><a href="/2016/05/12/Redis-Dump部署/">2016-05-12</a></time>
      
      
  
    <h1 class="title"><a href="/2016/05/12/Redis-Dump部署/">Redis-Dump部署</a></h1>
  

    </header>
    <div class="entry">
      
        <p>Redis-Dump是一个导出Redis数据为JSON格式的工具,使用Ruby开发.<br>Redis-Dump能够实现对指定数据库的导入导出操作,本文就介绍一下它的安装方法</p>
<p>操作系统    CentOS 6.x</p>
<p>安装RVM<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gpg --keyserver hkp://keys.gnupg.net --recv-keys <span class="number">409</span>B6B1796C275462A1703113804BB82D39DC0E3</span><br><span class="line">curl <span class="operator">-s</span>SL https://get.rvm.io | bash <span class="operator">-s</span> stable</span><br></pre></td></tr></table></figure></p>
<p>生效RVM环境变量<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /etc/profile.d/rvm.sh</span><br></pre></td></tr></table></figure></p>
<p>修改RVM源为Ruby China的源<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"ruby_url=https://cache.ruby-china.org/pub/ruby"</span> &gt; /usr/<span class="built_in">local</span>/rvm/user/db</span><br></pre></td></tr></table></figure></p>
<p>使用RVM安装Ruby<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rvm requirements</span><br><span class="line">rvm install <span class="number">2.3</span>.<span class="number">0</span></span><br></pre></td></tr></table></figure></p>
<p>设置Ruby版本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rvm use <span class="number">2.3</span>.<span class="number">0</span> --default</span><br></pre></td></tr></table></figure></p>
<p>安装Redis-Dump<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gem install redis-dump</span><br></pre></td></tr></table></figure></p>
<p><strong>FAQ</strong><br>如果出现gem无法安装的情况,如下:<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR:  While executing gem ... (Gem::RemoteFetcher::FetchError)&#10;    SSL_connect SYSCALL returned=5 errno=0 state=SSLv2/v3 read server hello A (https://rubygems.global.ssl.fastly.net/quick/Marshal.4.8/redis-3.3.0.gemspec.rz)</span><br></pre></td></tr></table></figure></p>
<p>这是由于墙的问题,替换为淘宝的源就好了<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gem sources --add https://ruby.taobao.org/ --remove https://rubygems.org/</span><br></pre></td></tr></table></figure></p>
<p>参考站点<br><a href="https://ruby-china.org/wiki/install_ruby_guide" target="_blank" rel="external">https://ruby-china.org/wiki/install_ruby_guide</a><br><a href="https://github.com/delano/redis-dump" target="_blank" rel="external">https://github.com/delano/redis-dump</a><br><a href="https://ruby.taobao.org/" target="_blank" rel="external">https://ruby.taobao.org/</a></p>
<p>have fun !</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2016-03-21T07:34:05.000Z"><a href="/2016/03/21/使用xtrabackup工具动态增加mysql从库/">2016-03-21</a></time>
      
      
  
    <h1 class="title"><a href="/2016/03/21/使用xtrabackup工具动态增加mysql从库/">使用xtrabackup工具动态增加mysql从库</a></h1>
  

    </header>
    <div class="entry">
      
        <p>xtrabackup是一个用于mysql数据备份和恢复的工具,这里只是简单用来做扩充mysql从库的示例.</p>
<p>系统环境<br>CentOS    6.7<br>MySQL    5.6.28<br>xtrabackup    2.3.3-1</p>
<p>安装xtrabackup(rpm包的方式)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum -y install perl perl-devel libaio libaio-devel perl-Time-HiRes perl-DBD-MySQL libev libev-devel</span><br><span class="line">wget https://www.percona.com/downloads/XtraBackup/Percona-XtraBackup-<span class="number">2.3</span>.<span class="number">3</span>/binary/redhat/<span class="number">6</span>/x86_64/percona-xtrabackup-<span class="number">2.3</span>.<span class="number">3</span>-<span class="number">1</span>.el6.x86_64.rpm</span><br><span class="line">rpm -ivh percona-xtrabackup-<span class="number">2.3</span>.<span class="number">3</span>-<span class="number">1</span>.el6.x86_64.rpm</span><br></pre></td></tr></table></figure></p>
<p>备份数据(在mysql主库所在服务器执行)<br>(以时间戳方式生成备份数据文件夹)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">innobackupex --user=root --password=<span class="number">123456</span> --backup /backup/</span><br></pre></td></tr></table></figure></p>
<p>拷贝备份的数据到新的从服务器上<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp -r /backup/<span class="number">2016</span>-<span class="number">03</span>-<span class="number">21</span>_14-<span class="number">49</span>-<span class="number">15</span>    root@new_mysql_slave:/backup/</span><br></pre></td></tr></table></figure></p>
<p>新mysql从服务器的操作<br>停止mysql服务<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/mysqld stop</span><br></pre></td></tr></table></figure></p>
<p>清空mysql的数据目录<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir /tmp/mysql_bak</span><br><span class="line">mv /var/lib/mysql/* /tmp/mysql_bak/</span><br></pre></td></tr></table></figure></p>
<p>恢复mysql数据<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">innobackupex --user=root --password=<span class="number">123456</span> --copy-back /backup/<span class="number">2016</span>-<span class="number">03</span>-<span class="number">21</span>_14-<span class="number">49</span>-<span class="number">15</span>/</span><br></pre></td></tr></table></figure></p>
<p>调整mysql数据文件夹权限<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown -R mysql.mysql /var/lib/mysql</span><br></pre></td></tr></table></figure></p>
<p>启动mysql服务<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/mysqld start</span><br></pre></td></tr></table></figure></p>
<p>查看xtrabackup_info文件,确定mysql主的bin-log信息<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">less /backup/<span class="number">2016</span>-<span class="number">03</span>-<span class="number">21</span>_14-<span class="number">49</span>-<span class="number">15</span>/xtrabackup_info</span><br><span class="line">binlog_pos = filename <span class="string">'mysql-bin.000001'</span>, position <span class="string">'120'</span></span><br></pre></td></tr></table></figure></p>
<p>设置主从同步<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; change master to master_host=<span class="string">'mysql_master_ip'</span>,master_user=<span class="string">'repl'</span>,master_password=<span class="string">'12345'</span>,master_<span class="built_in">log</span>_file=<span class="string">'mysql-bin.000001'</span>,master_<span class="built_in">log</span>_pos=<span class="number">120</span>;</span><br><span class="line">mysql&gt; start slave;</span><br></pre></td></tr></table></figure></p>
<p>查看主从状态是否正常.</p>
<p>参考站点:<br><a href="http://lizhenliang.blog.51cto.com/7876557/1669829?hmsr=toutiao.io&amp;utm_medium=toutiao.io&amp;utm_source=toutiao.io" target="_blank" rel="external">http://lizhenliang.blog.51cto.com/7876557/1669829?hmsr=toutiao.io&amp;utm_medium=toutiao.io&amp;utm_source=toutiao.io</a><br><a href="https://www.digitalocean.com/community/tutorials/how-to-create-hot-backups-of-mysql-databases-with-percona-xtrabackup-on-ubuntu-14-04" target="_blank" rel="external">https://www.digitalocean.com/community/tutorials/how-to-create-hot-backups-of-mysql-databases-with-percona-xtrabackup-on-ubuntu-14-04</a><br><a href="https://www.percona.com/doc/percona-xtrabackup/2.3/index.html#user-s-manual" target="_blank" rel="external">https://www.percona.com/doc/percona-xtrabackup/2.3/index.html#user-s-manual</a></p>
<p>have fun !</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2016-03-16T09:51:59.000Z"><a href="/2016/03/16/使用Dockerfile制作jdk和tomcat镜像/">2016-03-16</a></time>
      
      
  
    <h1 class="title"><a href="/2016/03/16/使用Dockerfile制作jdk和tomcat镜像/">使用Dockerfile制作jre和tomcat镜像</a></h1>
  

    </header>
    <div class="entry">
      
        <p>通过编写Dockerfile文件,制作了jdk和tomcat的镜像,算是练手了.</p>
<p>jre镜像对应的Dockerfile<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">FROM</span> centos</span><br><span class="line"><span class="built_in">MAINTAINER</span>    wfir</span><br><span class="line"><span class="built_in">COPY</span> <span class="bash">jdk1.<span class="number">7.0</span>_79 /usr/<span class="built_in">local</span>/jdk</span><br><span class="line"></span><span class="built_in">ENV</span> JAVA_HOME    /usr/local/jdk</span><br><span class="line"><span class="built_in">ENV</span> PATH    $JAVA_HOME/bin:$PATH</span><br><span class="line"><span class="built_in">ENV</span> CLASSPATH    .:$JAVA_HOME/lib/tools.jar:$JAVA_HOME/lib/dt.jar</span><br></pre></td></tr></table></figure></p>
<p>执行构建<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t wfir:jre-<span class="number">7</span> .</span><br></pre></td></tr></table></figure></p>
<p>以交互方式运行容器,查看jdk安装情况<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it wfir:jre-<span class="number">7</span> /bin/bash</span><br></pre></td></tr></table></figure></p>
<p>备注<br>在Dockerfile同级目录中需要有jdk1.7.0_79文件夹</p>
<p>tomcat镜像对应的Dockerfile<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">FROM</span> wfir:jre-<span class="number">7</span></span><br><span class="line"><span class="built_in">MAINTAINER</span>    wfir</span><br><span class="line"><span class="built_in">EXPOSE</span> <span class="number">8080</span></span><br><span class="line">COPY apr-<span class="number">1.5</span>.<span class="number">2</span>.tar.gz /usr/local/src/</span><br><span class="line"><span class="built_in">COPY</span> <span class="bash">apr-util-<span class="number">1.5</span>.<span class="number">4</span>.tar.gz /usr/<span class="built_in">local</span>/src/</span><br><span class="line"></span><span class="built_in">COPY</span> <span class="bash">apr-install.sh /usr/<span class="built_in">local</span>/src/</span><br><span class="line"></span><span class="built_in">COPY</span> <span class="bash">tomcat8 /usr/<span class="built_in">local</span>/tomcat8</span><br><span class="line"></span><span class="built_in">COPY</span> <span class="bash">tomcat-install.sh /usr/<span class="built_in">local</span>/src/</span><br><span class="line"></span><span class="built_in">RUN</span> <span class="bash">yum -y install gcc make</span><br><span class="line"></span><span class="built_in">RUN</span> <span class="bash">/bin/bash /usr/<span class="built_in">local</span>/src/apr-install.sh</span><br><span class="line"></span><span class="built_in">RUN</span> <span class="bash">/bin/bash /usr/<span class="built_in">local</span>/src/tomcat-install.sh</span><br><span class="line"></span><span class="built_in">ENV</span> LD_LIBRARY_PATH $LD_LIBRARY_PATH:/usr/local/apr/lib</span><br><span class="line"><span class="built_in">CMD</span> <span class="bash">/usr/<span class="built_in">local</span>/tomcat8/bin/catalina.sh run</span></span><br></pre></td></tr></table></figure></p>
<p>apr-install.sh脚本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="shebang">#!/bin/bash</span></span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br><span class="line">apr_dir=/usr/<span class="built_in">local</span>/src</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$apr_dir</span></span><br><span class="line">tar zxf apr-<span class="number">1.5</span>.<span class="number">2</span>.tar.gz</span><br><span class="line">tar zxf apr-util-<span class="number">1.5</span>.<span class="number">4</span>.tar.gz</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$apr_dir</span>/apr-<span class="number">1.5</span>.<span class="number">2</span></span><br><span class="line">./configure </span><br><span class="line">make </span><br><span class="line">make install </span><br><span class="line">sleep <span class="number">2</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$apr_dir</span>/apr-util-<span class="number">1.5</span>.<span class="number">4</span></span><br><span class="line">./configure --with-apr=/usr/<span class="built_in">local</span>/apr </span><br><span class="line">make </span><br><span class="line">make install</span><br></pre></td></tr></table></figure></p>
<p>tomcat-install.sh脚本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="shebang">#!/bin/bash</span></span><br><span class="line">tomcat_file=tomcat8</span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/<span class="variable">$&#123;tomcat_file&#125;</span>/bin</span><br><span class="line">tar zxf tomcat-native.tar.gz</span><br><span class="line"><span class="built_in">cd</span> tomcat-native-*-src/jni/native/</span><br><span class="line">./configure --with-apr=/usr/<span class="built_in">local</span>/apr --with-java-home=/usr/<span class="built_in">local</span>/jdk</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure></p>
<p>执行构建<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t wfir:tomcat8-jre7 .</span><br></pre></td></tr></table></figure></p>
<p>运行容器,映射tomcat运行端口和应用部署文件夹<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run <span class="operator">-d</span> -p <span class="number">8080</span>:<span class="number">8080</span> -v /tmp/webapps:/usr/<span class="built_in">local</span>/tomcat8/webapps -v /tmp/tomcatlogs:/usr/<span class="built_in">local</span>/tomcat8/logs wfir:tomcat8-jre7</span><br></pre></td></tr></table></figure></p>
<p>备注<br>在Dockerfile同级目录需要有文档中需要的各个软件包和脚本文件</p>
<p>后续可以把制作的docker镜像传到dockerhub上,略.</p>
<p>have fun !</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2016-03-10T06:24:53.000Z"><a href="/2016/03/10/NFS服务和mount操作/">2016-03-10</a></time>
      
      
  
    <h1 class="title"><a href="/2016/03/10/NFS服务和mount操作/">NFS服务和mount操作</a></h1>
  

    </header>
    <div class="entry">
      
        <p>关于NFS服务和相关的mount操作有很多文章了,这里简单说几句.</p>
<p>centos6系列nfs相关的服务是nfs,并需要开启rpcbind,rpcbind类似于centos5中的portmap,nfs通过在rpc上进行注册,确定和客户端的通讯端口.<br>需要注意的是,在启动nfs服务器之前要启动rpcbind,这样nfs才能和客户端确定通讯端口.重启rpcbind,它会清空所有的注册信息,所以,rpcbind所有注册的服务需要重启来重新向rpc注册.</p>
<p>关于mount的参数<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hard &#34920;&#31034;&#24403;&#26381;&#21153;&#31471;&#21644;&#23458;&#25143;&#31471;&#26377;&#19968;&#26041;&#26029;&#32447;&#21518;,rpc&#20250;&#25345;&#32493;&#30340;&#21628;&#21483;,&#30452;&#21040;&#23545;&#26041;&#24674;&#22797;&#36830;&#32447;&#20026;&#20027;.&#10;soft &#34920;&#31034;&#24403;&#26381;&#21153;&#31471;&#21644;&#23458;&#25143;&#31471;&#26377;&#19968;&#26041;&#26029;&#32447;&#21518;,rpc&#20250;&#22312;timeout&#21518;&#37325;&#22797;&#21628;&#21483;,&#32780;&#19981;&#26159;&#36830;&#32493;&#21628;&#21483;.&#10;&#22914;&#26524;NFS&#26381;&#21153;&#31471;&#32463;&#24120;&#37325;&#21551;,&#24314;&#35758;&#37319;&#29992;soft&#27169;&#24335;.&#10;intr &#34920;&#31034;&#24403;&#20351;&#29992;hard&#27169;&#24335;&#26102;,&#22914;&#26524;&#21152;&#19978;intr&#21442;&#25968;,&#21017;&#24403;rpc&#25345;&#32493;&#21628;&#21483;&#20013;,&#36825;&#27425;&#21628;&#21483;&#21487;&#20197;&#34987;&#20013;&#26029;.&#10;rsize,wrize &#34920;&#31034;&#20889;&#20837;&#20889;&#20986;&#30340;&#21306;&#22359;&#22823;&#23567;,&#40664;&#35748;&#26159;1024bytes,&#21487;&#20197;&#36866;&#24403;&#35843;&#22823;&#19968;&#20123;&#26469;&#25552;&#39640;nfs&#20256;&#36755;&#24615;&#33021;.</span><br></pre></td></tr></table></figure></p>
<p>mount还有很多参数,通过以下命令可以自行查询:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">man nfs</span><br></pre></td></tr></table></figure></p>
<p>线上一例分析:</p>
<p>采用NFS的方式进行文件共享,有一台客户端采用的硬连接方式进行挂载,参数如下:<br>mount -t nfs -o rw nfsserver:/test /test<br>当NFS服务器出现故障断线后,导致操作的大量mv操作的文件进程出现睡眠状态(state    D),无法通过kill的方式进行消除,导致共享目录不能成功挂载,只能通过重启服务器解决问题.</p>
<p>改进措施:<br>1 采用soft方式<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -t nfs -o soft,rw nfsserver:/<span class="built_in">test</span> /<span class="built_in">test</span></span><br></pre></td></tr></table></figure></p>
<p>2 采用hard,intr方式(推荐方式)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -t nfs -o hard,intr,rw nfsserver:/<span class="built_in">test</span> /<span class="built_in">test</span></span><br></pre></td></tr></table></figure></p>
<p>以上两种方式都能够通过中断操作结束占用共享文件夹的进程,无需重启服务器,即可进行重新挂载.</p>
<p>参考站点<br><a href="http://linux.vbird.org/linux_server/0330nfs.php" target="_blank" rel="external">http://linux.vbird.org/linux_server/0330nfs.php</a><br><a href="http://www.slashroot.in/linux-nfs-network-file-system-client-and-server-complete-guide" target="_blank" rel="external">http://www.slashroot.in/linux-nfs-network-file-system-client-and-server-complete-guide</a><br><a href="http://www.slashroot.in/how-do-linux-nfs-performance-tuning-and-optimization" target="_blank" rel="external">http://www.slashroot.in/how-do-linux-nfs-performance-tuning-and-optimization</a><br><a href="http://linoxide.com/nfs/difference-soft-hard-nfs-mount/" target="_blank" rel="external">http://linoxide.com/nfs/difference-soft-hard-nfs-mount/</a></p>
<p>have fun !</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2016-03-02T07:23:13.000Z"><a href="/2016/03/02/tmux使用初步/">2016-03-02</a></time>
      
      
  
    <h1 class="title"><a href="/2016/03/02/tmux使用初步/">tmux使用初步</a></h1>
  

    </header>
    <div class="entry">
      
        <p>tmux是一款终端使用工具,可以保持ssh操作状态.<br>下面简单说说怎么用.</p>
<p>安装<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># fedora 22</span></span><br><span class="line">sudo dnf install -y tmux</span><br><span class="line"><span class="comment">#mac</span></span><br><span class="line">brew install tmux</span><br></pre></td></tr></table></figure></p>
<p>启动tmux,并给session命名<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建一个叫test的session</span></span><br><span class="line">tmux new <span class="operator">-s</span> <span class="built_in">test</span></span><br></pre></td></tr></table></figure></p>
<p>查看tmux seesion<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tmux ls</span><br></pre></td></tr></table></figure></p>
<p>进入session<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tmux attach -t <span class="built_in">test</span></span><br></pre></td></tr></table></figure></p>
<p>tmux通过快捷键实现终端操作,快捷键前缀是Ctrl+b,其他操作在快捷键前缀后操作<br>常用按键如下<a href="http://mingxinglai.com/cn/2012/09/tmux/" target="_blank" rel="external">1</a></p>
<ul>
<li>C-b ? 显示快捷键帮助</li>
<li>C-b C-o 调换窗口位置，类似与vim 里的C-w</li>
<li>C-b 空格键 采用下一个内置布局</li>
<li>C-b ! 把当前窗口变为新窗口</li>
<li>C-b “ 横向分隔窗口</li>
<li>C-b % 纵向分隔窗口</li>
<li>C-b q 显示分隔窗口的编号</li>
<li>C-b o 跳到下一个分隔窗口</li>
<li>C-b 上下键 上一个及下一个分隔窗口</li>
<li>C-b C-方向键 调整分隔窗口大小</li>
<li>C-b c 创建新窗口</li>
<li>C-b 0~9 选择几号窗口</li>
<li>C-b c 创建新窗口</li>
<li>C-b n 选择下一个窗口</li>
<li>C-b l 切换到最后使用的窗口</li>
<li>C-b p 选择前一个窗口</li>
<li>C-b w 以菜单方式显示及选择窗口</li>
<li>C-b t 显示时钟</li>
<li>C-b ; 切换到最后一个使用的面板</li>
<li>C-b x 关闭面板</li>
<li>C-b &amp; 关闭窗口</li>
<li>C-b s 以菜单方式显示和选择会话</li>
<li>C-b d 退出tumx，并保存当前会话，这时，tmux仍在后台运行，可以通过tmux attach进入 到指定的会话</li>
</ul>
<p>tmux也有配置文件,在~/.tmux.conf(没有需要创建)<br>可以添加个性化配置项,暂时没需求.</p>
<p>参考站点<br><a href="http://mingxinglai.com/cn/2012/09/tmux/" target="_blank" rel="external">http://mingxinglai.com/cn/2012/09/tmux/</a><br><a href="http://blog.chh.tw/posts/tmux-terminal-multiplexer/" target="_blank" rel="external">http://blog.chh.tw/posts/tmux-terminal-multiplexer/</a><br><a href="https://blog.longwin.com.tw/2011/04/tmux-learn-screen-config-2011/" target="_blank" rel="external">https://blog.longwin.com.tw/2011/04/tmux-learn-screen-config-2011/</a></p>
<p>have fun !</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2016-03-01T09:34:44.000Z"><a href="/2016/03/01/Ansible介绍/">2016-03-01</a></time>
      
      
  
    <h1 class="title"><a href="/2016/03/01/Ansible介绍/">Ansible介绍</a></h1>
  

    </header>
    <div class="entry">
      
        <p>ansible介绍<br>python实现的自动化部署配置管理平台<br>agentless方式,使用ssh的方式进行连接</p>
<p>ansible架构</p>
<p><img src="/images/ansible-arch.jpg" alt=""></p>
<p>ansible安装<br>yum源安装:    yum install -y ansible (添加epel源)<br>pip安装:    pip install ansible(先安装pip)</p>
<p>ansible目录结构<br>/etc/ansible<br>├── ansible.cfg<br>├── hosts<br>└── roles<br>ansible.cfg    ansible配置文件<br>hosts        填写的主机列表文件<br>roles        存放自定义角色的文件夹</p>
<p>ansible命令介绍<br>安装后直接执行ansible即可,ansible命令常用参数如下:<br>ansible <host-pattern> [options]</host-pattern></p>
<p><host-pattern>    填写hosts文件中定义的服务器名称或服务器组名称<br>[options]<br>-a MODULE_ARGS, –args=MODULE_ARGS    ansible模块所需的参数信息<br>-C, –check    不进行实际的操作,只是尝试查看可能的操作<br>-e EXTRA_VARS, –extra-vars=EXTRA_VARS    添加额外的变量值<br>-h, –help    帮助信息<br>–list-hosts    列出服务器列表<br>-m MODULE_NAME, –module-name=MODULE_NAME    ansible要执行模块的名称<br> -u REMOTE_USER, –user=REMOTE_USER    远程连接所用的用户<br>-v, –verbose    长信息,-vvv显示更多的信息,-vvvv显示调试信息<br>–version    显示ansible版本</host-pattern></p>
<p>ansible执行示例<br>ansible zookeeper -m ping<br>ansible zookeeper -m shell -a “date”</p>
<p>ansible-playbooks<br>通过ansible-playbooks可以把一系列的部署配置工作集成到一起操作,减少脚本的编写过程<br>以zookeeper-cluster为例介绍<br>目录结构<br>zookeeper-cluster<br>├── files<br>│   └── zookeeper-3.4.6.tar.gz<br>├── group_vars<br>│   └── zookeeper_hosts<br>├── hosts<br>├── main.yaml<br>└── roles<br>    └── zookeeper<br>        ├── tasks<br>        │   └── main.yml<br>        └── templates<br>            ├── myid.j2<br>            └── zoo.cfg.j2<br>files文件夹    存放执行过程中需要的文件,比如zookeeper安装包<br>group_vars文件夹    存放执行过程中需要填写的变量值文件<br>hosts文件    安装zookeeper的主机列表<br>main.yaml    执行命令组合文件<br>roles文件夹    角色列表,与main.yaml中的配置对应</p>
<p>ansible-playbook命令常用参数<br>ansible-playbook playbook.yml<br>Options:<br>-C, –check    不进行实际的操作,只是尝试查看可能的操作<br>-e EXTRA_VARS, –extra-vars=EXTRA_VARS    添加额外的变量值<br>-h, –help    查看帮助<br>-i INVENTORY, –inventory-file=INVENTORY    指定hosts文件,默认是/etc/ansible/hosts<br>–syntax-check    执行语法检查<br>-t TAGS, –tags=TAGS    只执行指定tag值得操作<br> -u REMOTE_USER, –user=REMOTE_USER    远程连接所用的用户<br>-v, –verbose    长信息,-vvv显示更多的信息,-vvvv显示调试信息<br>–version    显示ansible版本</p>
<p>ansible-playbook执行示例<br>ansible-playbook -i hosts main.yaml</p>
<p>ansible常用模块介绍<br>查看ansible内置模块<br>ansible-doc -l    模块列表<br>ansible-doc -s 模块名称    模块帮助信息<br>ping:    测试远程主机是否运行<br>file:    设置远程文件的属性<br>copy:    复制文件或文件夹到远程主机<br>shell:    远程执行shell命令<br>command:    与shell类似<br>service:    管理远程主机服务<br>yum:    远程yum安装软件包<br>user:    用户管理<br>group:    用户组管理<br>script:    远程执行指定脚本<br>unarchive:    解压文件并放到指定目录<br>template:    复制模板文件到远程主机<br>delegate_to:    同时执行相关主机组<br>with_items:    变量和值</p>
<p>参考资料<br><a href="http://docs.ansible.com/ansible/" target="_blank" rel="external">http://docs.ansible.com/ansible/</a><br><a href="http://www.178linux.com/doc/ansible/index.html" target="_blank" rel="external">http://www.178linux.com/doc/ansible/index.html</a><br><a href="http://xiaorui.cc/category/ansible/" target="_blank" rel="external">http://xiaorui.cc/category/ansible/</a></p>
<p>have fun !</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2016-02-25T03:54:41.000Z"><a href="/2016/02/25/LVS-DR模式部署配置/">2016-02-25</a></time>
      
      
  
    <h1 class="title"><a href="/2016/02/25/LVS-DR模式部署配置/">LVS/DR模式部署配置</a></h1>
  

    </header>
    <div class="entry">
      
        <p>LVS/DR配合Keepalived实现服务的高可用和负载均衡的文章已经非常多了,我这里记录一下生产环境的使用情况.<br>以针对Redis从服务提供负载读为例进行说明:</p>
<p>服务器信息<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lvs/keepalived&#26381;&#21153;&#22120;&#9;&#9;192.168.10.11&#10;lvs/keepalived&#26381;&#21153;&#22120;&#9;&#9;192.168.10.12&#10;redis&#20174;&#26381;&#21153;&#22120;1&#9;&#9;&#9;192.168.10.110&#10;redis&#20174;&#26381;&#21153;&#22120;2&#9;&#9;&#9;192.168.10.120&#10;&#10;vip(&#22312;lvs&#26381;&#21153;&#22120;&#32465;&#23450;)&#9;&#9;192.168.10.150</span><br></pre></td></tr></table></figure></p>
<p>基本架构图<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#10;    192.168.10.150:6379(vip)&#10;           /            \&#10;192.168.10.110:6379       192.168.10.120:6379</span><br></pre></td></tr></table></figure></p>
<p>基本软件安装<br>keepalived安装<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y ipvsadm libnl-devel popt-devel keepalived</span><br></pre></td></tr></table></figure></p>
<p>keepalived配置文件/etc/keepalived/keepalived.conf<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">global_defs &#123;&#10;  router_id LVS_MASTER&#10;&#125;&#10;&#10;vrrp_instance VI_1 &#123;&#10;  state BACKUP&#10;  interface eth0&#10;  virtual_router_id 51&#10;  priority 100&#9;&#9;#&#21478;&#19968;&#21488;keepalived&#37197;&#32622;&#20026;90&#10;  advert_int 1&#10;  nopreempt&#9;&#9;#&#21478;&#19968;&#21488;&#19981;&#29992;&#37197;&#32622;&#36825;&#20010;&#21442;&#25968;&#10;  authentication &#123;&#10;    auth_type PASS&#10;    auth_pass 1111&#10;  &#125;&#10;  virtual_ipaddress &#123;&#10;    192.168.10.150&#10;  &#125;&#10;&#125;&#10; &#10;virtual_server 192.168.10.150 6379 &#123;&#10;  delay_loop 6&#10;  lb_algo rr&#10;  lb_kind DR&#10;  nat_mask 255.255.255.0&#10;  protocol TCP&#10; &#10;  real_server 192.168.10.110 6379 &#123;&#10;    weight 1&#10;    TCP_CHECK &#123;&#10;      connect_timeout 10&#10;      nb_get_retry 3&#10;      delay_before_retry 3&#10;      connect_port 6379&#10;    &#125;&#10;  &#125;&#10;  real_server 192.168.10.120 6379 &#123;&#10;    weight 1&#10;    TCP_CHECK &#123;&#10;      connect_timeout 10&#10;      nb_get_retry 3&#10;      delay_before_retry 3&#10;      connect_port 6379&#10;    &#125;&#10;  &#125;&#10;&#125;</span><br></pre></td></tr></table></figure></p>
<p>启动keepalived<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/keepalived restart</span><br></pre></td></tr></table></figure></p>
<p>在Redis服务器上配置针对LVS/DR模式的内核参数配置<br>在/usr/local/bin下创建lvsadm脚本<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash&#10;VIP=192.168.10.150&#10;source /etc/rc.d/init.d/functions&#10;case &#34;$1&#34; in&#10;start)&#10;  echo &#34;start LVS RealServer VIP&#34;&#10;  echo &#34;1&#34; &#62;/proc/sys/net/ipv4/conf/lo/arp_ignore&#10;  echo &#34;2&#34; &#62;/proc/sys/net/ipv4/conf/lo/arp_announce&#10;  echo &#34;1&#34; &#62; /proc/sys/net/ipv4/conf/eth0/arp_ignore&#10;  echo &#34;2&#34; &#62; /proc/sys/net/ipv4/conf/eth0/arp_announce&#10;  echo &#34;1&#34; &#62;/proc/sys/net/ipv4/conf/all/arp_ignore&#10;  echo &#34;2&#34; &#62;/proc/sys/net/ipv4/conf/all/arp_announce&#10;  /sbin/ifconfig lo:0 $VIP broadcast $VIP netmask 255.255.255.255 up&#10;  /sbin/route add -host $VIP dev lo:0&#10;;;&#10;stop)&#10;  /sbin/route del -host $VIP dev lo:0&#10;  /sbin/ifconfig lo:0 down&#10;  echo &#34;close LVS RealServer VIP&#34;&#10;  echo &#34;0&#34; &#62;/proc/sys/net/ipv4/conf/lo/arp_ignore&#10;  echo &#34;0&#34; &#62;/proc/sys/net/ipv4/conf/lo/arp_announce&#10;  echo &#34;0&#34; &#62;/proc/sys/net/ipv4/conf/all/arp_ignore&#10;  echo &#34;0&#34; &#62;/proc/sys/net/ipv4/conf/all/arp_announce&#10;  echo &#34;0&#34; &#62;/proc/sys/net/ipv4/conf/eth0/arp_ignore&#10;  echo &#34;0&#34; &#62;/proc/sys/net/ipv4/conf/eth0/arp_announce&#10;;;&#10;*)&#10;  echo &#34;Usage: $0 &#123;start|stop&#125;&#34;&#10;  exit 1&#10;esac</span><br></pre></td></tr></table></figure></p>
<p>开启LVS/DR模式<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /usr/<span class="built_in">local</span>/bin/lvsadm</span><br><span class="line">lvsadm start</span><br></pre></td></tr></table></figure></p>
<p>备注<br>LVS/DR模式要求所有服务器都在一个网段.<br>Redis部署配置略</p>
<p>have fun !</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2016-02-16T03:23:14.000Z"><a href="/2016/02/16/mha部署配置以及使用keepalived做vip漂移/">2016-02-16</a></time>
      
      
  
    <h1 class="title"><a href="/2016/02/16/mha部署配置以及使用keepalived做vip漂移/">mha部署配置以及使用keepalived做vip漂移</a></h1>
  

    </header>
    <div class="entry">
      
        <p>mha是用来解决mysql高可用,实现mysql主从切换的一套软件,分为node和manager两个角色.<br>keepalived通常用来实现应用的高可用,在这里通过和mha的结合,实现mysql主服务器vip的故障漂移能力.</p>
<p>本文主要写一下我的实践.</p>
<p>实验用服务器的角色分配如下:<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql master/keepalived&#9;&#9;&#9;&#9;&#9;192.168.10.12&#10;mysql slave(&#22791;&#29992;master)/keepalived&#9;&#9;192.168.10.13&#10;mysql slave&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;192.168.10.14&#10;mha manager&#9;&#9;&#9;&#9;&#9;&#9;&#9;&#9;192.168.10.15</span><br></pre></td></tr></table></figure></p>
<p>根据分配的服务器角色,先把需要的软件安装上,mysql部署以及主从配置略过.</p>
<p>mha node包安装(在所有服务器上安装,包括mha manager节点)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install -y perl-DBD-MySQL</span><br><span class="line">rpm -ivh mha4mysql-node-<span class="number">0.56</span>-<span class="number">0</span>.el6.noarch.rpm</span><br></pre></td></tr></table></figure></p>
<p>mha manager包安装<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install -y perl-DBD-MySQL perl-Config-Tiny perl-Log-Dispatch perl-Parallel-ForkManager perl-Time-HiRes</span><br><span class="line">rpm -ivh mha4mysql-manager-<span class="number">0.56</span>-<span class="number">0</span>.el6.noarch.rpm</span><br></pre></td></tr></table></figure></p>
<p>keepalived安装<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install -y ipvsadm libnl-devel popt-devel</span><br><span class="line">yum install -y keepalived</span><br></pre></td></tr></table></figure></p>
<p>在各个服务器上配置/etc/hosts文件,内容如下:<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.10.12&#9;node2&#10;192.168.10.13&#9;node3&#10;192.168.10.14&#9;node4&#10;192.168.10.15&#9;node5</span><br></pre></td></tr></table></figure></p>
<p>keepalived配置文件/etc/keepalived/keepalived.conf内容如下:<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">! Configuration File for keepalived&#10;&#10;global_defs &#123;&#10;   notification_email &#123;&#10;     acassen@firewall.loc&#10;     failover@firewall.loc&#10;     sysadmin@firewall.loc&#10;   &#125;&#10;   notification_email_from Alexandre.Cassen@firewall.loc&#10;   smtp_server 127.0.0.1&#10;   smtp_connect_timeout 30&#10;   router_id LVS_DEVEL&#10;&#125;&#10;&#10;vrrp_instance VI_1 &#123;&#10;    state BACKUP&#10;    interface eth1&#10;    virtual_router_id 51&#10;    priority 100&#10;    advert_int 1&#10;    nopreempt&#10;    authentication &#123;&#10;        auth_type PASS&#10;        auth_pass 1111&#10;    &#125;&#10;    virtual_ipaddress &#123;&#10;        192.168.10.150&#10;    &#125;&#10;&#125;</span><br></pre></td></tr></table></figure></p>
<p>启动keepalived,查看vip是否绑定成功<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/keepalived restart</span><br><span class="line"></span><br><span class="line">ip a</span><br></pre></td></tr></table></figure></p>
<p>mha配置<br>1 配置manager到各个node的ssh免密码登录<br>2 配置node节点之间的ssh免密码登录,包括node本服务器的<br>3 在manager上新建/etc/mha/app1.conf配置文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[server default]</span><br><span class="line">check_repl_delay=<span class="number">0</span></span><br><span class="line">manager_<span class="built_in">log</span>=/var/<span class="built_in">log</span>/masterha/app1/app1.log</span><br><span class="line">manager_workdir=/var/<span class="built_in">log</span>/masterha/app1</span><br><span class="line">master_binlog_dir=/var/lib/mysql/</span><br><span class="line">master_ip_failover_script=/usr/<span class="built_in">local</span>/bin/master_ip_failover</span><br><span class="line">password=<span class="number">123456</span></span><br><span class="line">ping_interval=<span class="number">2</span></span><br><span class="line">remote_workdir=/var/<span class="built_in">log</span>/masterha/app1</span><br><span class="line">repl_password=<span class="number">12345</span></span><br><span class="line">repl_user=repl</span><br><span class="line">report_script=/usr/<span class="built_in">local</span>/bin/send_report</span><br><span class="line"><span class="comment">#secondary_check_script=/usr/bin/masterha_secondary_check -s node3 --user=root --master_host=node2 --master_ip=192.168.10.12 --master_port=3306</span></span><br><span class="line">ssh_user=root</span><br><span class="line">user=root</span><br><span class="line"></span><br><span class="line">[server1]</span><br><span class="line">candidate_master=<span class="number">1</span></span><br><span class="line">hostname=node2</span><br><span class="line"></span><br><span class="line">[server2]</span><br><span class="line">candidate_master=<span class="number">1</span></span><br><span class="line">hostname=node3</span><br><span class="line"></span><br><span class="line">[server3]</span><br><span class="line">hostname=node4</span><br></pre></td></tr></table></figure></p>
<p>4 复制manager源码包中scripts文件夹下的脚本到manager所在服务器的/usr/local/bin目录下<br>5 修改master_ip_failover脚本,加入keepalived的vip漂移功能<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env perl</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  Copyright (C) 2011 DeNA Co.,Ltd.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  This program is free software; you can redistribute it and/or modify</span></span><br><span class="line"><span class="comment">#  it under the terms of the GNU General Public License as published by</span></span><br><span class="line"><span class="comment">#  the Free Software Foundation; either version 2 of the License, or</span></span><br><span class="line"><span class="comment">#  (at your option) any later version.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  This program is distributed in the hope that it will be useful,</span></span><br><span class="line"><span class="comment">#  but WITHOUT ANY WARRANTY; without even the implied warranty of</span></span><br><span class="line"><span class="comment">#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></span><br><span class="line"><span class="comment">#  GNU General Public License for more details.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  You should have received a copy of the GNU General Public License</span></span><br><span class="line"><span class="comment">#   along with this program; if not, write to the Free Software</span></span><br><span class="line"><span class="comment">#  Foundation, Inc.,</span></span><br><span class="line"><span class="comment">#  51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Note: This is a sample script and is not complete. Modify the script based on your environment.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> strict;</span><br><span class="line"><span class="keyword">use</span> warnings <span class="string">FATAL =&gt;</span> <span class="string">'all'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> Getopt::Long;</span><br><span class="line"><span class="keyword">use</span> MHA::DBHelper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">my</span> (</span><br><span class="line">  <span class="variable">$command</span>,        <span class="variable">$ssh_user</span>,         <span class="variable">$orig_master_host</span>,</span><br><span class="line">  <span class="variable">$orig_master_ip</span>, <span class="variable">$orig_master_port</span>, <span class="variable">$new_master_host</span>,</span><br><span class="line">  <span class="variable">$new_master_ip</span>,  <span class="variable">$new_master_port</span>,  <span class="variable">$new_master_user</span>,</span><br><span class="line">  <span class="variable">$new_master_password</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">my</span> <span class="variable">$vip</span> = <span class="string">'192.168.10.150'</span>;</span><br><span class="line"><span class="keyword">my</span> <span class="variable">$ssh_start_vip</span> = <span class="string">"/etc/init.d/keepalived start"</span>;</span><br><span class="line"><span class="keyword">my</span> <span class="variable">$ssh_stop_vip</span> = <span class="string">"/etc/init.d/keepalived stop"</span>;</span><br><span class="line"></span><br><span class="line">GetOptions(</span><br><span class="line">  <span class="string">'command=s'</span>             =&gt; \<span class="variable">$command</span>,</span><br><span class="line">  <span class="string">'ssh_user=s'</span>            =&gt; \<span class="variable">$ssh_user</span>,</span><br><span class="line">  <span class="string">'orig_master_host=s'</span>    =&gt; \<span class="variable">$orig_master_host</span>,</span><br><span class="line">  <span class="string">'orig_master_ip=s'</span>      =&gt; \<span class="variable">$orig_master_ip</span>,</span><br><span class="line">  <span class="string">'orig_master_port=i'</span>    =&gt; \<span class="variable">$orig_master_port</span>,</span><br><span class="line">  <span class="string">'new_master_host=s'</span>     =&gt; \<span class="variable">$new_master_host</span>,</span><br><span class="line">  <span class="string">'new_master_ip=s'</span>       =&gt; \<span class="variable">$new_master_ip</span>,</span><br><span class="line">  <span class="string">'new_master_port=i'</span>     =&gt; \<span class="variable">$new_master_port</span>,</span><br><span class="line">  <span class="string">'new_master_user=s'</span>     =&gt; \<span class="variable">$new_master_user</span>,</span><br><span class="line">  <span class="string">'new_master_password=s'</span> =&gt; \<span class="variable">$new_master_password</span>,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">exit</span> &amp;main();</span><br><span class="line"></span><br><span class="line"><span class="sub"><span class="keyword">sub</span> main &#123;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">print</span> <span class="string">"\n\nIN SCRIPT TEST====<span class="variable">$ssh_stop_vip</span>==<span class="variable">$ssh_start_vip</span>===\n\n"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( <span class="variable">$command</span> eq <span class="string">"stop"</span> || <span class="variable">$command</span> eq <span class="string">"stopssh"</span> ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># $orig_master_host, $orig_master_ip, $orig_master_port are passed.</span></span><br><span class="line">    <span class="comment"># If you manage master ip address at global catalog database,</span></span><br><span class="line">    <span class="comment"># invalidate orig_master_ip here.</span></span><br><span class="line">    <span class="keyword">my</span> <span class="variable">$exit_code</span> = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">eval</span> &#123;</span><br><span class="line">      <span class="keyword">print</span> <span class="string">"Disableing the VIP on old master:<span class="variable">$orig_master_host</span> \n"</span>;</span><br><span class="line">      &amp;stop_vip();</span><br><span class="line">      <span class="comment"># updating global catalog, etc</span></span><br><span class="line">      <span class="variable">$exit_code</span> = <span class="number">0</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$@</span>) &#123;</span><br><span class="line">      <span class="keyword">warn</span> <span class="string">"Got Error: <span class="variable">$@</span>\n"</span>;</span><br><span class="line">      <span class="keyword">exit</span> <span class="variable">$exit_code</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">exit</span> <span class="variable">$exit_code</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">elsif</span> ( <span class="variable">$command</span> eq <span class="string">"start"</span> ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># all arguments are passed.</span></span><br><span class="line">    <span class="comment"># If you manage master ip address at global catalog database,</span></span><br><span class="line">    <span class="comment"># activate new_master_ip here.</span></span><br><span class="line">    <span class="comment"># You can also grant write access (create user, set read_only=0, etc) here.</span></span><br><span class="line">    <span class="keyword">my</span> <span class="variable">$exit_code</span> = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">eval</span> &#123;</span><br><span class="line">      <span class="keyword">print</span> <span class="string">"Enable the VIP - <span class="variable">$vip</span> on the new master - <span class="variable">$new_master_host</span> \n"</span>;</span><br><span class="line">      &amp;start_vip();</span><br><span class="line"><span class="comment">=pod    </span><br><span class="line">      my $new_master_handler = new MHA::DBHelper();</span><br><span class="line"></span><br><span class="line">      # args: hostname, port, user, password, raise_error_or_not</span><br><span class="line">      $new_master_handler-&gt;connect( $new_master_ip, $new_master_port,</span><br><span class="line">        $new_master_user, $new_master_password, 1 );</span><br><span class="line"></span><br><span class="line">      ## Set read_only=0 on the new master</span><br><span class="line">      $new_master_handler-&gt;disable_log_bin_local();</span><br><span class="line">      print "Set read_only=0 on the new master.\n";</span><br><span class="line">      $new_master_handler-&gt;disable_read_only();</span><br><span class="line"></span><br><span class="line">      ## Creating an app user on the new master</span><br><span class="line">      print "Creating app user on the new master..\n";</span><br><span class="line">      FIXME_xxx_create_user( $new_master_handler-&gt;&#123;dbh&#125; );</span><br><span class="line">      $new_master_handler-&gt;enable_log_bin_local();</span><br><span class="line">      $new_master_handler-&gt;disconnect();</span><br><span class="line"></span><br><span class="line">      ## Update master ip on the catalog database, etc</span><br><span class="line">      FIXME_xxx;</span><br><span class="line">=cut</span></span><br><span class="line"></span><br><span class="line">      <span class="variable">$exit_code</span> = <span class="number">0</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$@</span>) &#123;</span><br><span class="line">      <span class="keyword">warn</span> <span class="variable">$@</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment"># If you want to continue failover, exit 10.</span></span><br><span class="line">      <span class="keyword">exit</span> <span class="variable">$exit_code</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">exit</span> <span class="variable">$exit_code</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">elsif</span> ( <span class="variable">$command</span> eq <span class="string">"status"</span> ) &#123;</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"Checking the status of the script.. OK\n"</span>;</span><br><span class="line">    <span class="comment"># do nothing</span></span><br><span class="line">    <span class="keyword">exit</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    &amp;usage();</span><br><span class="line">    <span class="keyword">exit</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># A simple system call that enable the VIP on the new master</span></span><br><span class="line"><span class="sub"><span class="keyword">sub</span> start_vip() &#123;</span></span><br><span class="line">  <span class="string">`ssh $ssh_user\@$new_master_host \" $ssh_start_vip \"`</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># A simple system call that disable the VIP on the old_master</span></span><br><span class="line"><span class="sub"><span class="keyword">sub</span> stop_vip() &#123;</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span> <span class="keyword">unless</span> (<span class="variable">$ssh_user</span>);</span><br><span class="line">  <span class="string">`ssh $ssh_user\@$orig_master_host \" $ssh_stop_vip \"`</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="sub"><span class="keyword">sub</span> usage &#123;</span></span><br><span class="line">  <span class="keyword">print</span></span><br><span class="line"><span class="string">"Usage: master_ip_failover --command=start|stop|stopssh|status --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\n"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>使用mha命令check各项配置<br>1 查看各个node的ssh情况<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">masterha_check_ssh --conf=/etc/mha/app1.conf</span><br></pre></td></tr></table></figure></p>
<p>2 查看mysql的复制情况<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">masterha_check_repl --conf=/etc/mha/app1.conf</span><br></pre></td></tr></table></figure></p>
<p>3 查看mha manager运行情况<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">masterha_check_status --conf=/etc/mha/app1.cnf</span><br></pre></td></tr></table></figure></p>
<p>启动mha manager<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup masterha_manager --conf=/etc/mha/app1.conf --remove_dead_master_conf --ignore_laste_failover &gt; /var/<span class="built_in">log</span>/masterha/app1/manager.log <span class="number">2</span>&gt;&amp;<span class="number">1</span> &amp;</span><br></pre></td></tr></table></figure></p>
<p>测试mysql主从切换<br>1 停掉192.168.10.12上的mysql主<br>2 查看vip是否漂移到了192.168.10.13所在的服务器上<br>3 查看mysql主是否切换到了192.168.10.13上</p>
<p>注意事项:<br>1 关闭mysql的自动清理relay log选项,在所有mysql上执行以下命令<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql <span class="operator">-e</span> <span class="string">'set global relay_log_purge=0'</span></span><br></pre></td></tr></table></figure></p>
<p>2 mha manager在发生一次切换后会自动退出</p>
<p>参考站点<br><a href="https://code.google.com/p/mysql-master-ha/" target="_blank" rel="external">https://code.google.com/p/mysql-master-ha/</a><br><a href="http://blog.51yip.com/mysql/1722.html" target="_blank" rel="external">http://blog.51yip.com/mysql/1722.html</a><br><a href="http://hugnew.com/?p=749" target="_blank" rel="external">http://hugnew.com/?p=749</a><br><a href="http://blog.itpub.net/88305/viewspace-730135" target="_blank" rel="external">http://blog.itpub.net/88305/viewspace-730135</a><br><a href="http://blog.csdn.net/largetalk/article/details/10006899" target="_blank" rel="external">http://blog.csdn.net/largetalk/article/details/10006899</a><br><a href="http://itindex.net/detail/39086-mysql-%E5%90%8C%E6%AD%A5-%E5%A4%8D%E5%88%B6" target="_blank" rel="external">http://itindex.net/detail/39086-mysql-%E5%90%8C%E6%AD%A5-%E5%A4%8D%E5%88%B6</a><br><a href="http://www.360doc.com/content/13/0219/10/10384031_266496886.shtml" target="_blank" rel="external">http://www.360doc.com/content/13/0219/10/10384031_266496886.shtml</a><br><a href="http://www.bubuko.com/infodetail-796423.html" target="_blank" rel="external">http://www.bubuko.com/infodetail-796423.html</a></p>
<p>have fun !</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2016-02-03T03:54:29.000Z"><a href="/2016/02/03/openvpn部署配置/">2016-02-03</a></time>
      
      
  
    <h1 class="title"><a href="/2016/02/03/openvpn部署配置/">openvpn部署配置</a></h1>
  

    </header>
    <div class="entry">
      
        <p>平台要求    CentOS 6.x</p>
<p>openvpn密钥登录方式部署</p>
<p>参考<a href="https://docs.ucloud.cn/software/vpn/OpenVPN4CentOS.html" target="_blank" rel="external">ucloud openvpn setup</a></p>
<p>openvpn系统账户密码登录方式部署</p>
<p>服务端配置</p>
<p>openvpn使用openvpn-auth-pam.so模块进行验证<br>如果你用openvpn的源码编译auth-pam模块很可能会失败,我告诉你openvpn-auth-pam.so在哪</p>
<ol>
<li><p>安装openvpn后,openvpn-auth-pam.so在以下地方</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/lib64/openvpn/plugins/openvpn-auth-pam.so</span><br></pre></td></tr></table></figure>
</li>
<li><p>拷贝openvpn-auth-pam.so到openvpn配置目录下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/lib64/openvpn/plugins/openvpn-auth-pam.so /etc/openvpn/</span><br></pre></td></tr></table></figure>
</li>
<li><p>server.conf配置文件如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">port <span class="number">6666</span></span><br><span class="line">proto tcp</span><br><span class="line">dev tun</span><br><span class="line">ca /etc/openvpn/ca.crt                <span class="comment">#文件名与创建服务端密钥步骤定义的文件名一致</span></span><br><span class="line">cert /etc/openvpn/server.crt          <span class="comment">#文件名与创建服务端密钥步骤定义的文件名一致</span></span><br><span class="line">key /etc/openvpn/server.key           <span class="comment">#文件名与创建服务端密钥步骤定义的文件名一致</span></span><br><span class="line">dh /etc/openvpn/dh2048.pem            <span class="comment">#文件名与创建服务端密钥步骤定义的文件名一致</span></span><br><span class="line">server <span class="number">10.10</span>.<span class="number">0.0</span> <span class="number">255.255</span>.<span class="number">255.0</span></span><br><span class="line">ifconfig-pool-persist ipp.txt</span><br><span class="line">push <span class="string">"route 192.168.1.0 255.255.255.0"</span></span><br><span class="line">keepalive <span class="number">10</span> <span class="number">120</span></span><br><span class="line">comp-lzo</span><br><span class="line">plugin /etc/openvpn/openvpn-auth-pam.so login    <span class="comment">#或者你可以直接调用openvpn-auth-pam.so(plugin /usr/lib64/openvpn/plugins/openvpn-auth-pam.so login)</span></span><br><span class="line">client-cert-not-required</span><br><span class="line">persist-key </span><br><span class="line">persist-tun </span><br><span class="line">status /var/<span class="built_in">log</span>/openvpn-status.log </span><br><span class="line"><span class="built_in">log</span> /var/<span class="built_in">log</span>/openvpn.log</span><br><span class="line">verb <span class="number">4</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动openvpn服务<br>chkconfig openvpn on<br>/etc/init.d/openvpn restart</p>
</li>
<li>创建系统账户并设置密码,用于vpn登录<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">useradd user1 <span class="operator">-s</span> /sbin/nologin</span><br><span class="line">passwd user1</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>客户端配置</p>
<ol>
<li><p>安装openvpn</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y openvpn</span><br></pre></td></tr></table></figure>
</li>
<li><p>客户端client.ovpn文件配置如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">client</span><br><span class="line">dev tun</span><br><span class="line">proto tcp</span><br><span class="line">remote openvpnserverip</span><br><span class="line">port <span class="number">6666</span></span><br><span class="line">remote-random</span><br><span class="line">resolv-retry infinite</span><br><span class="line">nobind</span><br><span class="line">persist-key</span><br><span class="line">persist-tun</span><br><span class="line">ca /etc/openvpn/config/ca.crt    <span class="comment">#ca文件是服务端生成的文件,拷贝过来的</span></span><br><span class="line">auth-user-pass</span><br><span class="line">ns-cert-type server</span><br><span class="line"><span class="comment">#tls-auth ta.key 1</span></span><br><span class="line">route-method exe</span><br><span class="line">route-delay <span class="number">2</span></span><br><span class="line">route <span class="number">192.168</span>.<span class="number">1.0</span> <span class="number">255.255</span>.<span class="number">255.0</span></span><br><span class="line">comp-lzo</span><br><span class="line">verb <span class="number">4</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>客户端user文件配置如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user1</span><br><span class="line"><span class="number">123456</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动openvpn<br>/usr/sbin/openvpn –config /etc/openvpn/config/client.ovpn –auth-user-pass /etc/openvpn/config/user &gt; /dev/null 2&gt;&amp;1</p>
</li>
</ol>
<p>openvpn连接的简易网络拓扑<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">client(tun0)    &gt;    server(openvpn)</span><br><span class="line">                           ∨</span><br><span class="line">                      eth1(tun0)    &gt;    eth0(<span class="number">192.168</span>.<span class="number">1.1</span>)</span><br><span class="line">                                                 ∨</span><br><span class="line">                                              servers</span><br></pre></td></tr></table></figure></p>
<p>openvpn server iptables规则</p>
<p>除了需要允许ssh端口访问之类的默认规则外,针对openvpn,添加以下规则(如果openvpn使用udp协议,修改对应规则即可)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p tcp -m state --state NEW -m tcp --dport <span class="number">6666</span> -j ACCEPT</span><br><span class="line">iptables -A INPUT <span class="operator">-s</span> <span class="number">10.10</span>.<span class="number">0.0</span>/<span class="number">24</span> -j ACCEPT</span><br><span class="line">iptables -A INPUT -i tun+ -j ACCEPT</span><br><span class="line">iptables -A FORWARD -i tun+ -j ACCEPT</span><br><span class="line">iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line">iptables -t nat -A POSTROUTING <span class="operator">-s</span> <span class="number">10.10</span>.<span class="number">0.0</span>/<span class="number">24</span> -o eth0 -j MASQUERADE</span><br><span class="line">/etc/init.d/iptables save</span><br></pre></td></tr></table></figure></p>
<p>openvpn server 系统内核配置(打开转发项)<br>在/etc/sysctl.conf文件中配置以下项<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.ip_forward = <span class="number">1</span></span><br></pre></td></tr></table></figure></p>
<p>使配置生效<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -p</span><br></pre></td></tr></table></figure></p>
<p>FAQ<br>openvpn部署完成后,遇到一个问题<br>vpn连接成功,无法访问内网的服务器.<br>解决:<br>openvpn server 启动vpn后,查看路由表,tun0设备应该有一条指向openvpn的网关,如果没有就需要添加<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">route add -net <span class="number">10.10</span>.<span class="number">0.0</span>/<span class="number">24</span> dev tun0</span><br></pre></td></tr></table></figure></p>
<p>内网中的其他服务器也要添加一条openvpn的网关,对应的是openvpn服务器的内网ip(添加到/etc/rc.local中,做为系统启动项)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">route add -net <span class="number">10.10</span>.<span class="number">0.0</span>/<span class="number">24</span> gw <span class="number">192.168</span>.<span class="number">1.1</span></span><br></pre></td></tr></table></figure></p>
<p>参考站点<br><a href="http://www.cnblogs.com/akkz/p/3604186.html" target="_blank" rel="external">http://www.cnblogs.com/akkz/p/3604186.html</a><br><a href="http://arashmilani.com/post?id=53" target="_blank" rel="external">http://arashmilani.com/post?id=53</a><br><a href="http://www.blogjava.net/vulcan/archive/2012/10/11/168685.html" target="_blank" rel="external">http://www.blogjava.net/vulcan/archive/2012/10/11/168685.html</a></p>
<p>have fun !</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>





<nav id="pagination">
  
    <a href="/" class="alignleft prev">上一頁</a>
  
  
    <a href="/page/3/" class="alignright next">下一頁</a>
  
  <div class="clearfix"></div>
</nav></div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜尋">
    <input type="hidden" name="q" value="site:wfirooooooo.github.io">
  </form>
</div>

  

  
<div class="widget tag">
  <h3 class="title">標籤</h3>
  <ul class="entry">
  
    <li><a href="/tags/activemq/">activemq</a><small>1</small></li>
  
    <li><a href="/tags/ansible/">ansible</a><small>2</small></li>
  
    <li><a href="/tags/docker/">docker</a><small>1</small></li>
  
    <li><a href="/tags/git/">git</a><small>1</small></li>
  
    <li><a href="/tags/golang/">golang</a><small>1</small></li>
  
    <li><a href="/tags/java/">java</a><small>1</small></li>
  
    <li><a href="/tags/keepalived/">keepalived</a><small>1</small></li>
  
    <li><a href="/tags/linux/">linux</a><small>1</small></li>
  
    <li><a href="/tags/lvs/">lvs</a><small>1</small></li>
  
    <li><a href="/tags/markdown/">markdown</a><small>1</small></li>
  
    <li><a href="/tags/mha/">mha</a><small>1</small></li>
  
    <li><a href="/tags/mysql/">mysql</a><small>4</small></li>
  
    <li><a href="/tags/nfs/">nfs</a><small>1</small></li>
  
    <li><a href="/tags/nginx/">nginx</a><small>1</small></li>
  
    <li><a href="/tags/openvpn/">openvpn</a><small>1</small></li>
  
    <li><a href="/tags/redis/">redis</a><small>2</small></li>
  
    <li><a href="/tags/shell/">shell</a><small>1</small></li>
  
    <li><a href="/tags/sysbench/">sysbench</a><small>1</small></li>
  
    <li><a href="/tags/tmux/">tmux</a><small>1</small></li>
  
    <li><a href="/tags/tomcat/">tomcat</a><small>1</small></li>
  
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2016 wfir
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>